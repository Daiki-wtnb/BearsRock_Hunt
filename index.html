<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BearsRock Hunt</title>
  <style>
  :root{
    --primary:#007AFF;
    --primary-light:#5AC8FA;
    --bg:#F2F2F7;
    --card:#FFFFFF;
    --border:#E5E5EA;
    --text:#000000;
    --text-secondary:#8E8E93;
    --success:#34C759;
    --error:#FF3B30;
    --shadow: 0 2px 12px rgba(0,0,0,0.08);
  }
  @media (prefers-color-scheme: dark) {
    :root{
      --primary:#0A84FF;
      --primary-light:#64D2FF;
      --bg:#000000;
      --card:#1C1C1E;
      --border:#38383A;
      --text:#FFFFFF;
      --text-secondary:#8E8E93;
      --success:#32D74B;
      --error:#FF453A;
      --shadow: 0 2px 12px rgba(0,0,0,0.3);
    }
  }
  *{ box-sizing:border-box; margin:0; padding:0; }
  html,body{ height:100%; }
  body{
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Hiragino Sans", "Noto Sans JP", sans-serif;
    background: var(--bg);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
  }
  .container{
    max-width: 600px;
    margin: 0 auto;
    padding: 16px;
    padding-bottom: calc(90px + env(safe-area-inset-bottom));
  }
  .header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding: 12px 0 20px;
  }
  .header h1{
    font-size: 32px;
    font-weight: 800;
    letter-spacing: -0.5px;
  }
  .badge{
    display:inline-flex;
    align-items:center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 14px;
    font-weight: 700;
    color: var(--text-secondary);
    box-shadow: var(--shadow);
  }
  .card{
    background: var(--card);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }
  .card-title{
    font-size: 20px;
    font-weight: 800;
    margin-bottom: 8px;
    letter-spacing: -0.3px;
  }
  .card-subtitle{
    font-size: 15px;
    color: var(--text-secondary);
    margin-bottom: 16px;
    line-height: 1.55;
  }
  .stats{
    display:flex;
    gap: 12px;
    margin-bottom: 16px;
  }
  .stat-item{
    flex:1;
    background: var(--bg);
    padding: 14px;
    border-radius: 12px;
    text-align:center;
    border: 1px solid rgba(0,0,0,0.02);
  }
  .stat-value{
    font-size: 26px;
    font-weight: 900;
    color: var(--primary);
    margin-bottom: 4px;
  }
  .stat-label{
    font-size: 13px;
    color: var(--text-secondary);
    font-weight: 700;
  }
  .progress-container{
    background: var(--bg);
    border-radius: 12px;
    height: 10px;
    overflow:hidden;
    margin: 14px 0 16px;
  }
  .progress-bar{
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--primary-light));
    border-radius: 12px;
    transition: width 0.35s ease;
  }
  .input-group{ margin-bottom: 14px; }
  .input-label{
    display:block;
    font-size: 14px;
    font-weight: 800;
    margin-bottom: 7px;
    color: var(--text);
  }
  input{
    width:100%;
    padding: 15px 14px;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--card);
    color: var(--text);
    font-size: 16px;
    outline:none;
    transition: all 0.15s;
  }
  input:focus{
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(0,122,255,0.12);
  }
  button{
    width:100%;
    padding: 15px 14px;
    border: none;
    border-radius: 12px;
    background: var(--primary);
    color: white;
    font-size: 16px;
    font-weight: 900;
    cursor:pointer;
    transition: all 0.15s;
    box-shadow: var(--shadow);
  }
  button:hover:not(:disabled){ opacity: .92; transform: translateY(-1px); }
  button:disabled{ opacity: .45; cursor: not-allowed; }
  .btn-secondary{
    background: var(--bg);
    color: var(--text);
    margin-top: 10px;
  }
  .alert{
    padding: 14px 14px;
    border-radius: 12px;
    margin: 12px 0;
    font-size: 14px;
    font-weight: 800;
    line-height: 1.45;
  }
  .alert-error{
    background: rgba(255,59,48,0.10);
    color: var(--error);
    border: 1px solid rgba(255,59,48,0.22);
  }
  .alert-success{
    background: rgba(52,199,89,0.10);
    color: var(--success);
    border: 1px solid rgba(52,199,89,0.22);
  }
  .link{ color: var(--primary); text-decoration:none; font-weight: 900; }
  .text-center{ text-align:center; }
  .text-muted{ color: var(--text-secondary); font-size: 14px; }
  .divider{ height:1px; background: var(--border); margin: 18px 0; }

  /* list / leaderboard */
  .list-item{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding: 14px;
    background: var(--bg);
    border-radius: 12px;
    margin-bottom: 10px;
  }
  .list-item.active{
    background: rgba(0,122,255,0.10);
    border: 1px solid rgba(0,122,255,0.22);
  }
  .rank-number{
    font-size: 18px;
    font-weight: 900;
    color: var(--text-secondary);
    min-width: 52px;
  }
  .rank-1 .rank-number{ color:#D4AF37; }
  .rank-2 .rank-number{ color:#C0C0C0; }
  .rank-3 .rank-number{ color:#CD7F32; }
  .me-badge{
    display:inline-flex;
    align-items:center;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 900;
    margin-left: 8px;
    border: 1px solid rgba(0,122,255,0.25);
    background: rgba(0,122,255,0.10);
    color: var(--primary);
  }
  .finish{
    display:inline-flex;
    align-items:center;
    gap: 6px;
    font-weight: 900;
    color: var(--primary);
  }
  .finish .done{ font-size: 16px; line-height: 1; }

  /* checkpoint */
  .checkpoint-card{
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white;
    padding: 22px;
    border-radius: 16px;
    margin: 16px 0;
    text-align:center;
  }
  .checkpoint-number{
    font-size: 46px;
    font-weight: 1000;
    margin-bottom: 6px;
  }
  .hint-box{
    background: var(--bg);
    padding: 14px;
    border-radius: 12px;
    margin: 12px 0;
    border-left: 4px solid var(--primary);
    line-height: 1.55;
    font-weight: 800;
  }

  /* trap */
  .trapCard{
    border: 1px solid rgba(255,59,48,.25);
    background: radial-gradient(120% 120% at 20% 0%, rgba(255,69,58,.18), transparent 55%),
                radial-gradient(120% 120% at 90% 20%, rgba(255,159,10,.14), transparent 55%),
                var(--card);
    position: relative;
    overflow: hidden;
  }
  .trapSkull{ font-size: 44px; }
  .glitch{
    font-weight: 1000;
    letter-spacing: .10em;
    text-transform: uppercase;
    position: relative;
    display:inline-block;
  }
  .glitch::before, .glitch::after{
    content: attr(data-text);
    position:absolute; left:0; top:0;
    opacity:.65;
  }
  .glitch::before{ transform: translate(2px,0); color: rgba(255,69,58,.9); }
  .glitch::after{ transform: translate(-2px,0); color: rgba(10,132,255,.9); }
  .smallHint{
    font-size: 13px;
    color: var(--text-secondary);
    margin-top: 10px;
    line-height: 1.55;
    font-weight: 800;
  }

  /* navbar */
  .navbar{
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: var(--card);
    border-top: 1px solid var(--border);
    display:flex;
    padding: 8px;
    padding-bottom: calc(8px + env(safe-area-inset-bottom));
    box-shadow: 0 -2px 12px rgba(0,0,0,0.08);
    z-index: 1000;
  }
  .nav-item{
    flex:1;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap: 4px;
    padding: 8px;
    text-decoration:none;
    color: var(--text-secondary);
    font-size: 10px;
    font-weight: 900;
    border-radius: 10px;
    transition: all 0.15s;
    user-select:none;
  }
  .nav-item.active{ color: var(--primary); }
  .nav-icon{ font-size: 22px; }

  /* shake */
  @keyframes shake{
    0%,100%{ transform: translateX(0); }
    25%{ transform: translateX(-8px); }
    75%{ transform: translateX(8px); }
  }
  .shake{ animation: shake 0.3s ease-in-out; }
  </style>
</head>

<body>
  <div class="container">
    <div id="app"></div>
  </div>

  <nav class="navbar">
    <a class="nav-item" href="#/"><div class="nav-icon">ğŸ </div><div>ãƒ›ãƒ¼ãƒ </div></a>
    <a class="nav-item" href="#/scan"><div class="nav-icon">ğŸ“·</div><div>ã‚¹ã‚­ãƒ£ãƒ³</div></a>
    <a class="nav-item" href="#/leaderboard"><div class="nav-icon">ğŸ†</div><div>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div></a>
    <a class="nav-item" href="#/me"><div class="nav-icon">ğŸ‘¤</div><div>ãƒã‚¤ãƒšãƒ¼ã‚¸</div></a>
  </nav>

  <script type="module">
    // import å®‰å®šç‰ˆï¼ˆesm.sh ãŒè½ã¡ã‚‹ç’°å¢ƒãŒã‚ã‚‹ã®ã§ jsdelivrï¼‰
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ====== è¨­å®š ======
    const SUPABASE_URL = "https://ahynlwtcdrtkzykcccgb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoeW5sd3RjZHJ0a3p5a2NjY2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MTA0MDQsImV4cCI6MjA4Mjk4NjQwNH0.HttRXUS-Qy6VA0t4UE8MIC58tgncg-2bucYfLr14LSA"; // â† ã“ã“ã ã‘å·®ã—æ›¿ãˆ

    const MAX_CHECKPOINT = 5;
    // =======================
// i18n (å¤šè¨€èª) åŸºæœ¬ã‚»ãƒƒãƒˆ
// =======================

// â‘  æ—¥æœ¬èªã‚’ãƒã‚¹ã‚¿ãƒ¼ï¼ˆæ­£æœ¬ï¼‰
const I18N_BASE = {
  APP_TITLE: "ğŸ BearsRockHunt",
  NAV_HOME: "ãƒ›ãƒ¼ãƒ ",
  NAV_SCAN: "ã‚¹ã‚­ãƒ£ãƒ³",
  NAV_RANK: "ãƒ©ãƒ³ã‚­ãƒ³ã‚°",
  NAV_ME: "ãƒã‚¤ãƒšãƒ¼ã‚¸",

  LOGIN_TITLE: "ãƒ­ã‚°ã‚¤ãƒ³",
  LOGIN_WELCOME: "ãŠã‹ãˆã‚Šãªã•ã„",
  LOGIN_DESC: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ ã¨PINã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",

  LABEL_NAME: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ ",
  LABEL_PIN: "PINã‚³ãƒ¼ãƒ‰",
  PLACEHOLDER_NAME: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ ã‚’å…¥åŠ›",
  PLACEHOLDER_PIN: "4æ¡ã®æ•°å­—",

  BTN_LOGIN: "ãƒ­ã‚°ã‚¤ãƒ³",
  BTN_SIGNUP: "ç™»éŒ²ã—ã¦é–‹å§‹",
};

// â‘¡ ä»–è¨€èªï¼ˆä¸Šæ›¸ãåˆ†ã ã‘ï¼‰
const I18N = {
  en: {
    NAV_HOME: "Home",
    NAV_SCAN: "Scan",
    NAV_RANK: "Ranking",
    NAV_ME: "Me",

    LOGIN_TITLE: "Log in",
    LOGIN_WELCOME: "Welcome back",
    LOGIN_DESC: "Enter your name and PIN",

    LABEL_NAME: "Name",
    LABEL_PIN: "PIN",
    PLACEHOLDER_NAME: "Enter your name",
    PLACEHOLDER_PIN: "4-digit PIN",

    BTN_LOGIN: "Log in",
    BTN_SIGNUP: "Start",
  }
};

// â‘¢ è¨€èªçŠ¶æ…‹ï¼ˆä¿å­˜ï¼‰
const LANG_KEY = "brh_lang";
let LANG = localStorage.getItem(LANG_KEY) || "ja";

// â‘£ ç¿»è¨³é–¢æ•°
function t(key, vars = {}) {
  const text =
    (LANG !== "ja" ? I18N[LANG]?.[key] : null) ??
    I18N_BASE[key] ??
    key;

  return String(text).replace(/\{(\w+)\}/g, (_, k) => vars[k] ?? `{${k}}`);
}

function setLang(lang) {
  LANG = lang;
  localStorage.setItem(LANG_KEY, lang);
  route(); // å†æç”»
}


    // âœ… æ­£è§£QRï¼ˆæ¨æ¸¬å¯¾ç­–ï¼‰
    // ä¾‹: #/c/1-f8K3
    const CP_KEYS = {
      1: "f8K3",
      2: "Qm9A",
      3: "Z7pL",
      4: "Kx2R",
      5: "Bde7",  // â† CP5ã‚’ä½œã‚‹ãªã‚‰ã“ã‚Œï¼ˆå¥½ãã«å¤‰ãˆã¦OKï¼‰
    };
    const TRAP_KEY = "TRAP"; // #/c/999-TRAP
    // ==================

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    const app = document.getElementById("app");

    // ====== utils ======
    const el = (html) => {
      const d = document.createElement("div");
      d.innerHTML = html.trim();
      return d.firstChild;
    };
    const progressPercent = (current, max = MAX_CHECKPOINT) => {
      const v = Math.max(0, Math.min(current, max));
      return Math.round((v / max) * 100);
    };
    const isIOS = () =>
      /iPad|iPhone|iPod/.test(navigator.userAgent) ||
      (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);

    function setNavActive() {
      const links = document.querySelectorAll(".nav-item");
      links.forEach(a => a.classList.remove("active"));
      const h = location.hash || "#/";
      const target =
        h.startsWith("#/c/") ? "#/" :
        (["#/scan","#/leaderboard","#/me","#/"].includes(h) ? h : "#/login");
      links.forEach(a => {
        if (a.getAttribute("href") === target) a.classList.add("active");
      });
    }

    // ====== router ======
    function getRoute() {
      const h = location.hash || "";

      if (h === "" || h === "#") return { type: "intro" };
      if (h === "#/intro") return { type: "intro" };
      if (h === "#/") return { type: "home" };

      // checkpoint
      const m = h.match(/^#\/c\/(\d+)-([A-Za-z0-9]+)$/);
      if (m) return { type: "cp", n: parseInt(m[1], 10), key: m[2] };

      if (h === "#/login") return { type: "login" };
      if (h === "#/signup") return { type: "signup" };
      if (h === "#/scan") return { type: "scan" };
      if (h === "#/leaderboard") return { type: "leaderboard" };
      if (h === "#/me") return { type: "me" };
      if (h === "#/clear") return { type: "clear" };

      return { type: "unknown" };
    }

    // ====== auth / db ======
    async function ensureAnonLogin() {
      const { data: { session } } = await sb.auth.getSession();
      if (session) return session;
      const { data, error } = await sb.auth.signInAnonymously();
      if (error) throw error;
      return data.session;
    }
    async function getMe() {
      const { data: { user } } = await sb.auth.getUser();
      return user;
    }
    async function getNickname(user_id) {
      const { data, error } = await sb.from("players").select("nickname").eq("user_id", user_id).maybeSingle();
      if (error) throw error;
      return data?.nickname ?? null;
    }
    async function getProgress(user_id) {
      const { data, error } = await sb.from("progress").select("checkpoint, updated_at").eq("user_id", user_id).maybeSingle();
      if (error) throw error;
      return data ?? { checkpoint: 0, updated_at: null };
    }

    // âœ… CPåˆ°é”æ›´æ–°ï¼ˆRPC: claim_checkpoint ã‚’ä½¿ã†ï¼‰
    async function advanceWithPassphrase(user_id, targetCheckpoint, passphrase) {
      const pass = (passphrase ?? "").trim();
      if (!pass) return { ok:false, reason:"no_passphrase" };

      const { data, error } = await sb.rpc("claim_checkpoint", { cp: targetCheckpoint, pass });
      if (error) {
        const m = error.message || String(error);
        if (m.includes("invalid passphrase")) return { ok:false, reason:"invalid_passphrase" };
        if (m.includes("wrong order")) {
          const cur = await getProgress(user_id);
          return { ok:false, reason:"wrong_order", current: cur.checkpoint };
        }
        return { ok:false, reason:"other", message: m };
      }
      return { ok:true, current: data ?? targetCheckpoint };
    }

    // ====== texts ======
    function hintText(n) {
      const hints = {
        1: "æ¯æœã€é´ãŒé›†ã¾ã‚‹å ´æ‰€ã®â€œä¸Šâ€ã‚’è¦‹ã‚",
        2: "ã„ã„åŒ‚ã„ãŒã™ã‚‹ã€‚ã•ã‚ã©ã“ã ã‚ã†",
        3: "ç”·ã©ã‚‚ãŒæ¯æœé›†ã¾ã‚‹å ´æ‰€",
        4: "ãã£ã›ãƒ¼ã€æ±šã­ãˆ",
        5: "ã‚¯ãƒªã‚¢ï¼"
      };
      return hints[n] ?? "ãƒ’ãƒ³ãƒˆãªã—";
    }

    // ====== render ======
    function renderIntro() {
      app.innerHTML = "";
      app.appendChild(el(`
        <div>
          <div class="header">
            <h1>ğŸ BearsRockHunt</h1>
            <div class="badge">ã‚¤ãƒ™ãƒ³ãƒˆ</div>
          </div>

          <div class="card">
            <div class="card-title">ã‚²ãƒ¼ãƒ èª¬æ˜</div>

            <p class="card-subtitle">
              BearsRockå†…ã«éš ã•ã‚ŒãŸQRã‚³ãƒ¼ãƒ‰ã‚’æ¢ã—ã¦é€²ã‚€å®æ¢ã—ã‚²ãƒ¼ãƒ ã§ã™ã€‚<br>
              ãƒ’ãƒ³ãƒˆã‚’é ¼ã‚Šã«ã€é †ç•ªé€šã‚Šãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¦ãã ã•ã„ã€‚
            </p>

            <div class="hint-box">
              <strong>ğŸ æ™¯å“</strong><br>
              å…¨ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ãŸäººã¯æ™¯å“ãŒã‚‚ã‚‰ãˆã¾ã™ã€‚<br>
              ï¼ˆéƒ¨å±‹ç•ªå·ãŒå¿…è¦ã§ã™ï¼‰
            </div>

            <div class="divider"></div>

            <p class="text-muted" style="font-size:13px;line-height:1.6;">
              ãƒ»PINï¼ˆ4æ¡ï¼‰ã¯å†ãƒ­ã‚°ã‚¤ãƒ³ã«å¿…è¦<br>
              ãƒ»æ¨æ¸¬URLã¯å…¨éƒ¨ãƒã‚ºãƒ¬<br>
              ãƒ»QRã®ä¸‹ã«æ›¸ã„ã¦ã‚ã‚‹ã€Œåˆè¨€è‘‰ã€ãŒå¿…è¦
            </p>

            <button type="button" style="margin-top:14px;" onclick="location.hash='#/login'">â–¶ï¸ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          </div>
        </div>
      `));
    }

    function renderHome(nickname, prog) {
      app.innerHTML = "";
      app.appendChild(el(`
        <div>
          <div class="header">
            <h1>ğŸ BearsRockHunt</h1>
            <div class="badge">ğŸ“ ${prog.checkpoint}/${MAX_CHECKPOINT}</div>
          </div>

          <div class="card">
            <div class="stats">
              <div class="stat-item">
                <div class="stat-value">${prog.checkpoint}</div>
                <div class="stat-label">ã‚¯ãƒªã‚¢æ¸ˆã¿</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${Math.max(0, MAX_CHECKPOINT - prog.checkpoint)}</div>
                <div class="stat-label">æ®‹ã‚Š</div>
              </div>
            </div>

            <div class="progress-container">
              <div class="progress-bar" style="width:${progressPercent(prog.checkpoint)}%"></div>
            </div>

            <p class="card-subtitle">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’é€²ã‚ã¾ã—ã‚‡ã†</p>
            <button type="button" onclick="location.hash='#/scan'">ğŸ“· QRã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>
          </div>

          <div class="card">
            <div class="card-title">ã‚ˆã†ã“ãã€${nickname}ã•ã‚“</div>
            <p class="text-muted">ãƒ’ãƒ³ãƒˆã¯ãƒã‚¤ãƒšãƒ¼ã‚¸ã§ç¢ºèªã§ãã¾ã™ã€‚</p>
          </div>
        </div>
      `));
    }

    function renderLogin() {
      app.innerHTML = "";
      const node = el(`
        <div>
          <div class="header"><h1>${t("LOGIN_TITLE")}</h1></div>
          <div class="card">
            <div class="card-title">ãŠã‹ãˆã‚Š</div>
            <p class="card-subtitle">ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ ã¨PINã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</p>

            <div class="input-group">
              <label class="input-label">ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ </label>
              <input id="nick" maxlength="20" placeholder="ä¾‹ï¼šBear" />
            </div>

            <div class="input-group">
              <label class="input-label">PINï¼ˆ4æ¡ï¼‰</label>
              <input id="pin" type="password" inputmode="numeric" maxlength="4" placeholder="0000" />
            </div>

            <button id="btn" type="button">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div id="msg"></div>

            <div class="divider"></div>
            <p class="text-center text-muted">
              åˆã‚ã¦ãªã‚‰ <a class="link" href="#/signup">æ–°è¦ç™»éŒ²</a>
            </p>
          </div>
        </div>
      `);

      node.querySelector("#btn").onclick = async () => {
        const btn = node.querySelector("#btn");
        const nick = node.querySelector("#nick").value.trim();
        const pin  = node.querySelector("#pin").value.trim();
        const msg  = node.querySelector("#msg");
        msg.innerHTML = "";

        if (!nick) { msg.innerHTML = '<div class="alert alert-error">ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦</div>'; node.classList.add("shake"); setTimeout(()=>node.classList.remove("shake"),300); return; }
        if (!/^[0-9]{4}$/.test(pin)) { msg.innerHTML = '<div class="alert alert-error">PINã¯4æ¡ã®æ•°å­—</div>'; node.classList.add("shake"); setTimeout(()=>node.classList.remove("shake"),300); return; }

        btn.disabled = true; btn.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ä¸­...";

        try{
          await ensureAnonLogin();
          const { error } = await sb.rpc("claim_player", { nick, pin });
          if (error) throw error;
          msg.innerHTML = '<div class="alert alert-success">âœ“ ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ</div>';
          setTimeout(()=> location.hash="#/", 350);
        }catch(e){
          msg.innerHTML = `<div class="alert alert-error">ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼š${e?.message ?? e}</div>`;
          node.classList.add("shake"); setTimeout(()=>node.classList.remove("shake"),300);
        }finally{
          btn.disabled = false; btn.textContent = "ãƒ­ã‚°ã‚¤ãƒ³";
        }
      };

      app.appendChild(node);
    }

    function renderSignup() {
      app.innerHTML = "";
      const node = el(`
        <div>
          <div class="header"><h1>æ–°è¦ç™»éŒ²</h1></div>
          <div class="card">
            <div class="card-title">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</div>
            <p class="card-subtitle">ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ  / éƒ¨å±‹ç•ªå· / PINã‚’è¨­å®š</p>

            <div class="input-group">
              <label class="input-label">ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ </label>
              <input id="nick" maxlength="20" placeholder="ä¾‹ï¼šDaiki" />
            </div>

            <div class="input-group">
              <label class="input-label">éƒ¨å±‹ç•ªå·</label>
              <input id="room" maxlength="10" placeholder="ä¾‹ï¼š203 / A-12" />
            </div>

            <div class="input-group">
              <label class="input-label">PINï¼ˆ4æ¡ï¼‰</label>
              <input id="pin" type="password" inputmode="numeric" maxlength="4" placeholder="0000" />
            </div>

            <button id="btn" type="button">ç™»éŒ²ã—ã¦é–‹å§‹</button>
            <div id="msg"></div>

            <div class="divider"></div>
            <p class="text-center text-muted">
              ç™»éŒ²æ¸ˆã¿ãªã‚‰ <a class="link" href="#/login">ãƒ­ã‚°ã‚¤ãƒ³</a>
            </p>
          </div>
        </div>
      `);

      node.querySelector("#btn").onclick = async () => {
        const btn = node.querySelector("#btn");
        const nick = node.querySelector("#nick").value.trim();
        const room = node.querySelector("#room").value.trim();
        const pin  = node.querySelector("#pin").value.trim();
        const msg  = node.querySelector("#msg");
        msg.innerHTML = "";

        if (!nick) { msg.innerHTML = '<div class="alert alert-error">ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦</div>'; node.classList.add("shake"); setTimeout(()=>node.classList.remove("shake"),300); return; }
        if (!room) { msg.innerHTML = '<div class="alert alert-error">éƒ¨å±‹ç•ªå·ã‚’å…¥åŠ›ã—ã¦</div>'; node.classList.add("shake"); setTimeout(()=>node.classList.remove("shake"),300); return; }
        if (!/^[0-9]{4}$/.test(pin)) { msg.innerHTML = '<div class="alert alert-error">PINã¯4æ¡ã®æ•°å­—</div>'; node.classList.add("shake"); setTimeout(()=>node.classList.remove("shake"),300); return; }

        btn.disabled = true; btn.textContent = "ç™»éŒ²ä¸­...";

        try{
          const { error } = await sb.rpc("register_player", { nick, pin, room });
          if (error) throw error;
          msg.innerHTML = '<div class="alert alert-success">âœ“ ç™»éŒ²å®Œäº†</div>';
          setTimeout(()=> location.hash="#/", 350);
        }catch(e){
          msg.innerHTML = `<div class="alert alert-error">ç™»éŒ²å¤±æ•—ï¼š${e?.message ?? e}</div>`;
          node.classList.add("shake"); setTimeout(()=>node.classList.remove("shake"),300);
        }finally{
          btn.disabled = false; btn.textContent = "ç™»éŒ²ã—ã¦é–‹å§‹";
        }
      };

      app.appendChild(node);
    }

    function renderCheckpoint(nickname, prog, target) {
      app.innerHTML = "";
      const locked = prog.checkpoint < (target - 1);

      const node = el(`
        <div>
          <div class="header">
            <h1>ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ</h1>
            <div class="badge">ğŸ“ ${prog.checkpoint}/${MAX_CHECKPOINT}</div>
          </div>

          <div class="checkpoint-card">
            <div class="checkpoint-number">${target}</div>
            <div style="font-weight:900;letter-spacing:.08em;">CHECKPOINT ${target}</div>
          </div>

          <div class="card">
            ${
              locked ? `
                <div class="alert alert-error">ğŸ”’ ã¾ã æ—©ã„ã€‚å…ˆã«CP${target-1}ã‚’ã‚¯ãƒªã‚¢ã—ã¦</div>
                <button class="btn-secondary" type="button" onclick="location.hash='#/'">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
              ` : `
                <div class="card-title">åˆ°é”ç¢ºèª</div>
                <p class="card-subtitle">QRã®ä¸‹ã«æ›¸ã„ã¦ã‚ã‚‹ã€Œåˆè¨€è‘‰ã€ã‚’å…¥åŠ›ã—ã¦ã­</p>

                <div class="input-group">
                  <label class="input-label">åˆè¨€è‘‰</label>
                  <input id="pass" maxlength="30" placeholder="åˆè¨€è‘‰ã‚’å…¥åŠ›" />
                </div>

                <button id="claim" type="button">âœ“ åˆ°é”ã‚’ç¢ºèª</button>
                <div id="msg"></div>

                <div id="hint" style="display:none;">
                  <div class="alert alert-success"><strong>ã‚¯ãƒªã‚¢ï¼</strong> æ¬¡ã®ãƒ’ãƒ³ãƒˆãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸ</div>
                  <div class="hint-box"><strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ ${target}</strong><br>${hintText(target)}</div>
                  <button class="btn-secondary" type="button" onclick="location.hash='#/'">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
                </div>
              `
            }
          </div>
        </div>
      `);

      if (!locked) {
        node.querySelector("#claim").onclick = async () => {
          const btn = node.querySelector("#claim");
          const msg = node.querySelector("#msg");
          const pass = node.querySelector("#pass").value;

          msg.innerHTML = "";
          btn.disabled = true; btn.textContent = "ç¢ºèªä¸­...";

          try{
            const me = await getMe();
            const res = await advanceWithPassphrase(me.id, target, pass);

            if (!res.ok) {
              if (res.reason === "no_passphrase") msg.innerHTML = `<div class="alert alert-error">åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦</div>`;
              else if (res.reason === "invalid_passphrase") msg.innerHTML = `<div class="alert alert-error">åˆè¨€è‘‰ãŒé•ã†</div>`;
              else if (res.reason === "wrong_order") msg.innerHTML = `<div class="alert alert-error">é †ç•ªãŒé•ã†ã€‚ã„ã¾ ${res.current} / ${MAX_CHECKPOINT}</div>`;
              else msg.innerHTML = `<div class="alert alert-error">å¤±æ•—ï¼š${res.message ?? "ã‚¨ãƒ©ãƒ¼"}</div>`;
              btn.disabled = false; btn.textContent = "âœ“ åˆ°é”ã‚’ç¢ºèª";
              return;
            }

            node.querySelector("#hint").style.display = "block";
            btn.style.display = "none";

            if (target >= MAX_CHECKPOINT) {
              setTimeout(()=> location.hash="#/clear", 450);
            }

          }catch(e){
            msg.innerHTML = `<div class="alert alert-error">ã‚¨ãƒ©ãƒ¼ï¼š${e?.message ?? e}</div>`;
            btn.disabled = false; btn.textContent = "âœ“ åˆ°é”ã‚’ç¢ºèª";
          }
        };
      }

      app.appendChild(node);
    }

    function renderTrap(nickname = "GUEST", prog = { checkpoint: 0 }, reason = "") {
      app.innerHTML = "";

      const lines = [
        "ã“ã“ã«ã¯ä½•ã‚‚ãªã„ã€‚",
        "æ¨æ¸¬ã—ã¦ã‚‚é€²æ—ã¯é€²ã¾ãªã„ã€‚",
        "è¿‘é“æ¢ã™ã‚ˆã‚Šã€ãƒ’ãƒ³ãƒˆæ¢ã›ã€‚",
        "ãã®æƒ…ç†±ã€æ­£è¦ãƒ«ãƒ¼ãƒˆã§é ¼ã‚€ã€‚",
      ];
      const msg = lines[Math.floor(Math.random() * lines.length)];

      app.appendChild(el(`
        <div>
          <div class="header"><h1>ğŸ˜ˆ ãƒã‚ºãƒ¬</h1></div>

          <div class="card trapCard">
            <div style="display:flex;align-items:center;gap:12px;">
              <div class="trapSkull">ğŸ’€</div>
              <div>
                <div class="glitch" data-text="TRAP">TRAP</div>
                <div class="text-muted" style="margin-top:6px;">${msg}</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="smallHint">
              <div>âœ… æ­£è§£QRã¯ã€Œæ±ºã‚ãŸURLã ã‘ã€</div>
              <div>ğŸ”’ æ¨æ¸¬URLã¯å…¨éƒ¨ãƒã‚ºãƒ¬</div>
              ${reason ? `<div style="opacity:.7;margin-top:6px;">debug: ${reason}</div>` : ``}
            </div>

            <div style="margin-top:14px;">
              <button type="button" onclick="location.hash='#/'">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
            </div>
          </div>
        </div>
      `));
    }

    function renderClear(nickname) {
      app.innerHTML = "";
      app.appendChild(el(`
        <div>
          <div class="header"><h1>ğŸ‰ ã‚¯ãƒªã‚¢ï¼</h1></div>

          <div class="card">
            <div class="card-title">ãŠã‚ã§ã¨ã†ã€${nickname}ï¼</div>
            <p class="card-subtitle">
              å…¨ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚<br>
              ã—ã°ã‚‰ãã™ã‚‹ã¨ã‚ãªãŸã®éƒ¨å±‹ã®å‰ã«æ™¯å“ãŒå±Šãã¾ã™ã€‚
            </p>

            <div class="hint-box">
              <strong>ğŸ æ™¯å“</strong><br>é£Ÿå ‚ãƒã‚±ãƒƒãƒˆ
            </div>

            <div class="divider"></div>

            <button type="button" onclick="location.hash='#/me'">ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚‹</button>
            <button class="btn-secondary" type="button" onclick="location.hash='#/'">ãƒ›ãƒ¼ãƒ ã¸</button>
          </div>
        </div>
      `));
    }

    function renderScan(nickname, prog) {
      app.innerHTML = "";

      const ios = isIOS();
      app.appendChild(el(`
        <div>
          <div class="header">
            <h1>ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³</h1>
            <div class="badge">ğŸ“ ${prog.checkpoint}/${MAX_CHECKPOINT}</div>
          </div>

          <div class="card">
            <div class="card-title">QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</div>

            ${
              ios ? `
                <div class="alert alert-success">
                  iPhoneã®æ–¹ã¯ã€æ¨™æº–ã‚«ãƒ¡ãƒ©ã§QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„
                </div>
                <p class="card-subtitle">
                  QRã‚’èª­ã‚€ã¨Safariã§ãƒšãƒ¼ã‚¸ãŒé–‹ãã¾ã™ã€‚<br>
                  é–‹ã„ãŸç”»é¢ã§ã€Œåˆ°é”ã‚’ç¢ºèªã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
                </p>
              ` : `
                <p class="card-subtitle">
                  Androidç­‰ã§ã¯ç«¯æœ«ã«ã‚ˆã£ã¦ãƒ–ãƒ©ã‚¦ã‚¶å†…ã‚¹ã‚­ãƒ£ãƒ³ã«å¯¾å¿œã—ã¾ã™ã€‚<br>
                  ã‚‚ã—å‹•ã‹ãªã‘ã‚Œã°æ¨™æº–ã‚«ãƒ¡ãƒ©ã§èª­ã‚“ã§ãã ã•ã„ã€‚
                </p>
                <div class="alert alert-success">ã“ã®ãƒšãƒ¼ã‚¸ã¯æ¡ˆå†…ã ã‘ã§ã™ï¼ˆQRã¯æ¨™æº–ã‚«ãƒ¡ãƒ©ã§OKï¼‰</div>
              `
            }
          </div>
        </div>
      `));
    }

    function renderMe(nickname, prog) {
      app.innerHTML = "";

      let hintsHtml = "";
      for (let i = 1; i <= Math.min(prog.checkpoint, MAX_CHECKPOINT); i++) {
        hintsHtml += `
          <div class="list-item">
            <div>
              <strong>ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ ${i}</strong>
              <div class="text-muted" style="font-size:13px;margin-top:4px;line-height:1.5;">${hintText(i)}</div>
            </div>
            <div style="font-size:18px;">âœ…</div>
          </div>
        `;
      }
      if (!hintsHtml) hintsHtml = `<p class="text-muted">ã¾ã ãƒ’ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;

      app.appendChild(el(`
        <div>
          <div class="header"><h1>ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</h1></div>

          <div class="card">
            <div class="card-title">${nickname}</div>

            <div class="stats">
              <div class="stat-item">
                <div class="stat-value">${prog.checkpoint}</div>
                <div class="stat-label">é€²æ—</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${progressPercent(prog.checkpoint)}%</div>
                <div class="stat-label">é”æˆç‡</div>
              </div>
            </div>

            <div class="progress-container">
              <div class="progress-bar" style="width:${progressPercent(prog.checkpoint)}%"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-title">è§£æ”¾æ¸ˆã¿ãƒ’ãƒ³ãƒˆ</div>
            <div style="margin-top:14px;">${hintsHtml}</div>
          </div>
        </div>
      `));
    }

    async function renderLeaderboard(nickname) {
      app.innerHTML = "";
      app.appendChild(el(`
        <div>
          <div class="header"><h1>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h1></div>
          <div class="card">
            <div class="card-title">é€²æ—ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
            <p class="card-subtitle">é€²æ—ãŒé«˜ã„é †ã€‚åŒç‡ã®å ´åˆã¯åˆ°é”ãŒæ—©ã„é †</p>
            <div id="list"></div>
          </div>
        </div>
      `));

      const list = document.getElementById("list");
      list.innerHTML = `<p class="text-muted text-center">èª­ã¿è¾¼ã¿ä¸­...</p>`;

      try{
        const { data, error } = await sb.rpc("get_leaderboard");
        if (error) throw error;

        if (!data?.length) {
          list.innerHTML = `<p class="text-muted text-center">ã¾ã èª°ã‚‚ã„ã¾ã›ã‚“</p>`;
          return;
        }

        list.innerHTML = data.map((r, idx) => {
          const isMe = (r.nickname === nickname);
          const topClass = idx===0 ? "rank-1" : idx===1 ? "rank-2" : idx===2 ? "rank-3" : "";
          const isClear = (r.checkpoint >= MAX_CHECKPOINT);
          const progressText = `${r.checkpoint} / ${MAX_CHECKPOINT}`;

          return `
            <div class="list-item ${isMe ? "active" : ""} ${topClass}">
              <div style="display:flex;align-items:center;gap:12px;flex:1;">
                <div class="rank-number">#${idx+1}</div>
                <div style="display:flex;align-items:center;flex-wrap:wrap;">
                  <strong>${r.nickname}</strong>
                  ${isMe ? `<span class="me-badge">ã‚ãªãŸ</span>` : ``}
                </div>
              </div>
              <div class="finish">
                <span>${progressText}</span>
                ${isClear ? `<span class="done">ğŸ‰</span>` : ``}
              </div>
            </div>
          `;
        }).join("");

      }catch(e){
        list.innerHTML = `<div class="alert alert-error">å–å¾—å¤±æ•—ï¼š${e?.message ?? e}</div>`;
      }
    }

    // ====== main route ======
    async function route() {
      try{
        setNavActive();
        await ensureAnonLogin();

        const r = getRoute();

        // intro
        if (r.type === "intro") { renderIntro(); return; }

        // unknown -> trap
        if (r.type === "unknown") { renderTrap("GUEST", { checkpoint: 0 }, "UNKNOWN"); return; }

        // cp key check (before login check)
        if (r.type === "cp") {
          // trap special
          if (r.n === 999) {
            if (r.key === TRAP_KEY) renderTrap("GUEST", { checkpoint: 0 }, "TRAP");
            else renderTrap("GUEST", { checkpoint: 0 }, "TRAP_KEY_MISMATCH");
            return;
          }
          // normal cp
          if (!CP_KEYS[r.n] || r.key !== CP_KEYS[r.n]) {
            renderTrap("GUEST", { checkpoint: 0 }, "KEY_MISMATCH");
            return;
          }
        }

        // auth state
        const me = await getMe();
        const nick = await getNickname(me.id);
        const prog = nick ? await getProgress(me.id) : { checkpoint: 0, updated_at: null };

        // allow login/signup without nick
        if (r.type === "login") { renderLogin(); return; }
        if (r.type === "signup") { renderSignup(); return; }

        // pages that require login
        const needsLogin = (r.type === "home" || r.type === "scan" || r.type === "leaderboard" || r.type === "me" || r.type === "cp" || r.type === "clear");
        if (!nick && needsLogin) { location.hash = "#/login"; return; }

        // route
        if (r.type === "home") { renderHome(nick, prog); return; }
        if (r.type === "scan") { renderScan(nick, prog); return; }
        if (r.type === "me") { renderMe(nick, prog); return; }
        if (r.type === "leaderboard") { await renderLeaderboard(nick); return; }
        if (r.type === "clear") { renderClear(nick); return; }
        if (r.type === "cp") { renderCheckpoint(nick, prog, r.n); return; }

        location.hash = "#/login";
      }catch(e){
        app.innerHTML = `
          <div class="card">
            <div class="card-title">ã‚¨ãƒ©ãƒ¼ã§åœæ­¢ã—ã¾ã—ãŸ</div>
            <div class="alert alert-error" style="margin-top:12px;">
              ${e?.message ?? e}
            </div>
            <div class="text-muted" style="margin-top:10px;line-height:1.6;">
              ãƒ»Supabaseã®ANON KEYã‚’å·®ã—æ›¿ãˆãŸï¼Ÿ<br>
              ãƒ»RPCï¼ˆregister_player / claim_player / claim_checkpoint / get_leaderboardï¼‰ã¯å­˜åœ¨ã™ã‚‹ï¼Ÿ<br>
              ãƒ»players / progress ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã‚ã‚‹ï¼Ÿ
            </div>
          </div>
        `;
        console.error(e);
      }
    }

    window.addEventListener("hashchange", route);
    if (!location.hash) location.hash = "#/intro";
    route();
  </script>
</body>
</html>

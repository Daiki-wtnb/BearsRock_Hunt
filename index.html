<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dorm QR Hunt</title>
  <style>
  :root{
    --primary:#007AFF;
    --primary-light:#5AC8FA;
    --bg:#F2F2F7;
    --card:#FFFFFF;
    --border:#E5E5EA;
    --text:#000000;
    --text-secondary:#8E8E93;
    --success:#34C759;
    --error:#FF3B30;
    --shadow: 0 2px 12px rgba(0,0,0,0.08);
  }

  @media (prefers-color-scheme: dark) {
    :root{
      --primary:#0A84FF;
      --primary-light:#64D2FF;
      --bg:#000000;
      --card:#1C1C1E;
      --border:#38383A;
      --text:#FFFFFF;
      --text-secondary:#8E8E93;
      --success:#32D74B;
      --error:#FF453A;
      --shadow: 0 2px 12px rgba(0,0,0,0.3);
    }
  }

  *{ box-sizing:border-box; margin:0; padding:0; }
  html,body{ height:100%; }
  body{
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Hiragino Sans", "Noto Sans JP", sans-serif;
    background: var(--bg);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
  }

  .container{
    max-width: 600px;
    margin: 0 auto;
    padding: 16px;
    padding-bottom: calc(80px + env(safe-area-inset-bottom));
  }

  .header{
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 0 20px;
  }

  .header h1{
    font-size: 34px;
    font-weight: 700;
    letter-spacing: -0.5px;
  }

  .badge{
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    box-shadow: var(--shadow);
  }

  .card{
    background: var(--card);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }

  .card-title{
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 8px;
    letter-spacing: -0.3px;
  }

  .card-subtitle{
    font-size: 15px;
    color: var(--text-secondary);
    margin-bottom: 16px;
    line-height: 1.5;
  }

  .stats{
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
  }

  .stat-item{
    flex: 1;
    background: var(--bg);
    padding: 16px;
    border-radius: 12px;
    text-align: center;
  }

  .stat-value{
    font-size: 28px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 4px;
  }

  .stat-label{
    font-size: 13px;
    color: var(--text-secondary);
    font-weight: 500;
  }

  .progress-container{
    background: var(--bg);
    border-radius: 12px;
    height: 8px;
    overflow: hidden;
    margin: 16px 0;
  }

  .progress-bar{
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--primary-light));
    border-radius: 12px;
    transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  input{
    width: 100%;
    padding: 16px;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--card);
    color: var(--text);
    font-size: 17px;
    outline: none;
    transition: all 0.2s;
  }

  input:focus{
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(0,122,255,0.1);
  }

  .input-group{ margin-bottom: 16px; }
  .input-label{
    display: block;
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text);
  }

  button{
    width: 100%;
    padding: 16px;
    border: none;
    border-radius: 12px;
    background: var(--primary);
    color: white;
    font-size: 17px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: var(--shadow);
  }

  button:hover:not(:disabled){
    opacity: 0.9;
    transform: translateY(-1px);
  }

  button:disabled{ opacity: 0.4; cursor: not-allowed; }

  .btn-secondary{ background: var(--bg); color: var(--text); margin-top: 12px; }

  .alert{
    padding: 14px 16px;
    border-radius: 12px;
    margin: 12px 0;
    font-size: 15px;
    font-weight: 500;
    line-height: 1.4;
  }

  .alert-error{
    background: rgba(255,59,48,0.1);
    color: var(--error);
    border: 1px solid rgba(255,59,48,0.2);
  }

  .alert-success{
    background: rgba(52,199,89,0.1);
    color: var(--success);
    border: 1px solid rgba(52,199,89,0.2);
  }

  .link{ color: var(--primary); text-decoration: none; font-weight: 600; }
  .text-center{ text-align: center; }
  .text-muted{ color: var(--text-secondary); font-size: 15px; }
  .divider{ height: 1px; background: var(--border); margin: 20px 0; }

  .list-item{
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: var(--bg);
    border-radius: 12px;
    margin-bottom: 8px;
  }

  .list-item.active{
    background: rgba(0,122,255,0.1);
    border: 1px solid rgba(0,122,255,0.2);
  }

  .rank-number{
    font-size: 20px;
    font-weight: 700;
    color: var(--text-secondary);
    min-width: 48px;
  }

  .rank-number.top{ color: var(--primary); }

  video{
    width: 100%;
    border-radius: 16px;
    background: var(--bg);
    margin: 16px 0;
  }

  .button-group{ display: flex; gap: 12px; margin: 12px 0; }
  .button-group button{ flex: 1; }

  .navbar{
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: var(--card);
    border-top: 1px solid var(--border);
    display: flex;
    padding: 8px;
    padding-bottom: calc(8px + env(safe-area-inset-bottom));
    box-shadow: 0 -2px 12px rgba(0,0,0,0.08);
    z-index: 1000;
  }

  .nav-item{
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 8px;
    text-decoration: none;
    color: var(--text-secondary);
    font-size: 10px;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.2s;
  }

  .nav-item.active{ color: var(--primary); }
  .nav-icon{ font-size: 24px; }

  .hint-box{
    background: var(--bg);
    padding: 16px;
    border-radius: 12px;
    margin: 12px 0;
    border-left: 4px solid var(--primary);
  }

  @keyframes shake{
    0%,100%{ transform: translateX(0); }
    25%{ transform: translateX(-8px); }
    75%{ transform: translateX(8px); }
  }

  .shake{ animation: shake 0.3s ease-in-out; }

  .checkpoint-card{
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white;
    padding: 24px;
    border-radius: 16px;
    margin: 16px 0;
    text-align: center;
  }

  .checkpoint-number{
    font-size: 48px;
    font-weight: 800;
    margin-bottom: 8px;
  }
    /* --- Trap / Game feel --- */
.trapCard{
  border: 1px solid rgba(255,59,48,.25);
  background: radial-gradient(120% 120% at 20% 0%, rgba(255,69,58,.18), transparent 55%),
              radial-gradient(120% 120% at 90% 20%, rgba(255,159,10,.14), transparent 55%),
              var(--card);
  position: relative;
  overflow: hidden;
}
.trapSkull{
  font-size: 44px;
  animation: pulse 1.3s ease-in-out infinite;
}
@keyframes pulse{
  0%,100%{ transform: scale(1); opacity: .95; }
  50%{ transform: scale(1.06); opacity: 1; }
}
.glitch{
  font-weight: 800;
  letter-spacing: .08em;
  text-transform: uppercase;
  position: relative;
  display:inline-block;
}
.glitch::before, .glitch::after{
  content: attr(data-text);
  position:absolute; left:0; top:0;
  opacity:.65;
}
.glitch::before{ transform: translate(2px,0); color: rgba(255,69,58,.9); }
.glitch::after{ transform: translate(-2px,0); color: rgba(10,132,255,.9); }
.flicker{ animation: flicker 1.6s infinite; }
@keyframes flicker{
  0%,100%{ opacity:1; }
  45%{ opacity:.9; }
  50%{ opacity:.5; }
  55%{ opacity:.95; }
}
.smallHint{
  font-size: 13px;
  color: var(--text-secondary);
  margin-top: 10px;
  line-height: 1.5;
}
  /* --- leaderboard tweaks --- */
.me-badge{
  display:inline-flex;
  align-items:center;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 700;
  margin-left: 8px;
  border: 1px solid rgba(0,122,255,0.25);
  background: rgba(0,122,255,0.10);
  color: var(--primary);
}

.rank-1 .rank-number{ color: #D4AF37; } /* gold */
.rank-2 .rank-number{ color: #C0C0C0; } /* silver */
.rank-3 .rank-number{ color: #CD7F32; } /* bronze */

.finish{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-weight: 800;
  color: var(--primary);
}

.finish .done{
  font-size: 16px;
  line-height: 1;
}


  </style>
</head>

<body>
  <div class="container">
    <div id="app"></div>
  </div>

  <nav class="navbar">
    <a class="nav-item" href="#/">
      <div class="nav-icon">ğŸ </div><div>ãƒ›ãƒ¼ãƒ </div>
    </a>
    <a class="nav-item" href="#/scan">
      <div class="nav-icon">ğŸ“·</div><div>ã‚¹ã‚­ãƒ£ãƒ³</div>
    </a>
    <a class="nav-item" href="#/leaderboard">
      <div class="nav-icon">ğŸ†</div><div>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
    </a>
    <a class="nav-item" href="#/me">
      <div class="nav-icon">ğŸ‘¤</div><div>ãƒã‚¤ãƒšãƒ¼ã‚¸</div>
    </a>
  </nav>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://ahynlwtcdrtkzykcccgb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoeW5sd3RjZHJ0a3p5a2NjY2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MTA0MDQsImV4cCI6MjA4Mjk4NjQwNH0.HttRXUS-Qy6VA0t4UE8MIC58tgncg-2bucYfLr14LSA";
    const MAX_CHECKPOINT = 5;
    // âœ… ã“ã®4ã¤ã ã‘ãŒã€Œæ­£è§£QRã€
const CP_KEYS = {
  1: "f8K3",
  2: "Qm9A",
  3: "Z7pL",
  4: "Kx2R",
};
const TRAP_KEY = "TRAP";

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    const app = document.getElementById("app");

    const el = (html) => {
      const d = document.createElement("div");
      d.innerHTML = html.trim();
      return d.firstChild;
    };

    const progressPercent = (current, max = MAX_CHECKPOINT) => {
      const v = Math.max(0, Math.min(current, max));
      return Math.round((v / max) * 100);
    };

const getRoute = () => {
  const h = location.hash || "";

  // âœ… ãƒ«ãƒ¼ãƒˆã¯ home ã«ã™ã‚‹ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œã«å¿…ãšã“ã“ã¸æ¥ã‚‹ï¼‰
  if (h === "#/" ) return { type: "home" };

  // âœ… ä½•ã‚‚ãªã„ã¨ãã ã‘ intro ã«ã™ã‚‹ï¼ˆåˆå›ã‚¢ã‚¯ã‚»ã‚¹ç”¨ï¼‰
  if (h === "" || h === "#") return { type: "intro" };
  if (h === "#/intro") return { type: "intro" };

  // âœ… ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆï¼ˆãƒ©ãƒ³ãƒ€ãƒ å¿…é ˆï¼‰
  const m = h.match(/^#\/c\/(\d+)-([A-Za-z0-9]+)$/);
  if (m) return { type: "cp", n: parseInt(m[1], 10), key: m[2] };

  if (h === "#/login") return { type: "login" };
  if (h === "#/signup") return { type: "signup" };
  if (h === "#/scan") return { type: "scan" };
  if (h === "#/leaderboard") return { type: "leaderboard" };
  if (h === "#/me") return { type: "me" };
  if (h === "#/clear") return { type: "clear" };

  return { type: "unknown" };
};






    function setNavActive() {
      const links = document.querySelectorAll(".nav-item");
      links.forEach(a => a.classList.remove("active"));
      const h = location.hash || "#/";
      const target = h.startsWith("#/c/") ? "#/" : (["#/scan","#/leaderboard","#/me","#/"].includes(h) ? h : "#/login");
      links.forEach(a => {
        if (a.getAttribute("href") === target) a.classList.add("active");
      });
    }

    async function ensureAnonLogin() {
      const { data: { session } } = await sb.auth.getSession();
      if (session) return session;
      const { data, error } = await sb.auth.signInAnonymously();
      if (error) throw error;
      return data.session;
    }

    async function getMe() {
      const { data: { user } } = await sb.auth.getUser();
      return user;
    }

    async function getNickname(user_id) {
      const { data, error } = await sb
        .from("players").select("nickname").eq("user_id", user_id).maybeSingle();
      if (error) throw error;
      return data?.nickname ?? null;
    }

    async function getProgress(user_id) {
      const { data, error } = await sb
        .from("progress").select("checkpoint, updated_at").eq("user_id", user_id).maybeSingle();
      if (error) throw error;
      return data ?? { checkpoint: 0, updated_at: null };
    }

    async function advanceIfAllowed(user_id, targetCheckpoint, passphrase) {
  // user_id ã¯å°†æ¥ç”¨ï¼ˆã“ã®RPCã¯ auth.uid() ã‚’ä½¿ã†ã®ã§å¿…é ˆã§ã¯ãªã„ï¼‰
  const pass = (passphrase ?? "").trim();
  if (!pass) {
    return { ok: false, reason: "no_passphrase" };
  }

  const { data, error } = await sb.rpc("claim_checkpoint", {
    cp: targetCheckpoint,
    pass
  });

  if (error) {
    const m = error.message || String(error);

    if (m.includes("invalid passphrase")) {
      return { ok: false, reason: "invalid_passphrase" };
    }
    if (m.includes("wrong order")) {
      // ä»Šã®é€²æ—ã‚’å–ã‚Šç›´ã—ã¦è¿”ã™ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ï¼‰
      const current = await getProgress(user_id);
      return { ok: false, reason: "wrong_order", current: current.checkpoint };
    }
    return { ok: false, reason: "other", message: m };
  }

  // data ã¯æ›´æ–°å¾Œã® checkpointï¼ˆRPCãŒ return ã—ã¦ã‚‹æƒ³å®šï¼‰
  return { ok: true, current: data ?? targetCheckpoint };
}


    function hintText(n) {
      const hints = {
        1: "æ¯æœã€é´ãŒé›†ã¾ã‚‹å ´æ‰€ã®â€œä¸Šâ€ã‚’è¦‹ã‚",   // âœ…ã“ã“ä¿®æ­£
        2: "ã„ã„åŒ‚ã„ãŒã™ã‚‹ã€‚ã•ã‚ã©ã“ã ã‚ã†",
        3: "ç”·ã©ã‚‚ãŒæ¯æœé›†ã¾ã‚‹å ´æ‰€",
        4: "ãã£ã›ãƒ¼ã€æ±šã­ãˆ",
        5: "ã‚¯ãƒªã‚¢ï¼"
      };
      return hints[n] ?? "ãƒ’ãƒ³ãƒˆãªã—";
    }

    function renderHome(nickname, prog) {
      app.innerHTML = "";
      app.appendChild(el(`
        <div>
          <div class="header">
            <h1>ğŸ BearsRockHunt</h1>
            <div class="badge">ğŸ“ ${prog.checkpoint}/${MAX_CHECKPOINT}</div>
          </div>

          <div class="card">
            <div class="stats">
              <div class="stat-item">
                <div class="stat-value">${prog.checkpoint}</div>
                <div class="stat-label">ã‚¯ãƒªã‚¢æ¸ˆã¿</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${MAX_CHECKPOINT - prog.checkpoint}</div>
                <div class="stat-label">æ®‹ã‚Š</div>
              </div>
            </div>

            <div class="progress-container">
              <div class="progress-bar" style="width:${progressPercent(prog.checkpoint)}%"></div>
            </div>

            <p class="card-subtitle">QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’é€²ã‚ã¾ã—ã‚‡ã†</p>
            <button type="button" onclick="location.hash='#/scan'">ğŸ“· QRã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>
          </div>

          <div class="card">
            <div class="card-title">ã‚ˆã†ã“ãã€${nickname}ã•ã‚“</div>
            <p class="text-muted">æ¬¡ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’æ¢ã—ã¦ãã ã•ã„ã€‚ãƒ’ãƒ³ãƒˆã¯ãƒã‚¤ãƒšãƒ¼ã‚¸ã§ç¢ºèªã§ãã¾ã™ã€‚</p>
          </div>
        </div>
      `));
    }
function renderIntro() {
  app.innerHTML = "";

  app.appendChild(el(`
    <div>
      <div class="header">
        <h1>ğŸ BearsRockHunt</h1>
        <div class="badge">ã‚¤ãƒ™ãƒ³ãƒˆ</div>
      </div>

      <div class="card">
        <div class="card-title">ã‚²ãƒ¼ãƒ èª¬æ˜</div>

        <p class="card-subtitle">
          BearsRockå†…ã«éš ã•ã‚ŒãŸQRã‚³ãƒ¼ãƒ‰ã‚’æ¢ã—ã¦é€²ã‚€å®æ¢ã—ã‚²ãƒ¼ãƒ ã§ã™ã€‚<br>
          ãƒ’ãƒ³ãƒˆã‚’é ¼ã‚Šã«ã€é †ç•ªé€šã‚Šãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¦ãã ã•ã„ã€‚
        </p>

        <div class="hint-box">
          <strong>ğŸ æ™¯å“</strong><br>
          æœ€åˆã«å…¨ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ãŸäººã¯ã€æ™¯å“ãŒã‚‚ã‚‰ãˆã¾ã™ã€‚1ä½ã§ãªãã¦ã‚‚ã€é †ç•ªã§ãƒã‚¤ãƒ³ãƒˆãŒã‚‚ã‚‰ãˆã¾ã™ã€‚
        </div>

        <div class="divider"></div>

        <p class="text-muted" style="font-size:13px;">
          ãƒ»PINï¼ˆ4æ¡ï¼‰ã¯å†ãƒ­ã‚°ã‚¤ãƒ³ã«å¿…è¦ã§ã™<br>
          ãƒ»URLã‚’æ¨æ¸¬ã—ã¦ã‚‚é€²æ—ã¯é€²ã¿ã¾ã›ã‚“
        </p>

        <button style="margin-top:16px;" onclick="location.hash='#/login'">
          â–¶ï¸ ã‚¹ã‚¿ãƒ¼ãƒˆ
        </button>
      </div>
    </div>
  `));
}

    function renderLogin() {
      app.innerHTML = "";
      const node = el(`
        <div>
          <div class="header"><h1>ãƒ­ã‚°ã‚¤ãƒ³</h1></div>
          <div class="card">
            <div class="card-title">ãŠã‹ãˆã‚Šãªã•ã„</div>
            <p class="card-subtitle">ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ ã¨PINã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>

            <div class="input-group">
              <label class="input-label">ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ </label>
              <input id="nick" maxlength="20" placeholder="ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ ã‚’å…¥åŠ›" />
            </div>

            <div class="input-group">
              <label class="input-label">PINã‚³ãƒ¼ãƒ‰</label>
              <input id="pin" type="password" inputmode="numeric" maxlength="4" placeholder="4æ¡ã®æ•°å­—" />
            </div>

            <button id="btn" type="button">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div id="msg"></div>

            <div class="divider"></div>
            <p class="text-center text-muted">
              ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„æ–¹ã¯<br>
              <a href="#/signup" class="link">æ–°è¦ç™»éŒ²</a>
            </p>
          </div>
        </div>
      `);

      node.querySelector("#btn").onclick = async () => {
        const btn = node.querySelector("#btn");
        const nick = node.querySelector("#nick").value.trim();
        const pin  = node.querySelector("#pin").value.trim();
        const msg  = node.querySelector("#msg");
        msg.innerHTML = "";

        if (!nick) { msg.innerHTML = '<div class="alert alert-error">ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>'; node.classList.add("shake"); setTimeout(()=>node.classList.remove("shake"),300); return; }
        if (!/^[0-9]{4}$/.test(pin)) { msg.innerHTML = '<div class="alert alert-error">PINã‚³ãƒ¼ãƒ‰ã¯4æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>'; node.classList.add("shake"); setTimeout(()=>node.classList.remove("shake"),300); return; }

        btn.disabled = true;
        btn.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ä¸­...";

        try {
          await ensureAnonLogin();
          const { error } = await sb.rpc("claim_player", { nick, pin });
          if (error) throw error;
          msg.innerHTML = '<div class="alert alert-success">âœ“ ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ</div>';
          setTimeout(() => location.hash = "#/", 400);
        } catch (e) {
          msg.innerHTML = `<div class="alert alert-error">ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ<br>${e?.message ?? e}</div>`;
          node.classList.add("shake");
          setTimeout(()=>node.classList.remove("shake"),300);
        } finally {
          btn.disabled = false;
          btn.textContent = "ãƒ­ã‚°ã‚¤ãƒ³";
        }
      };

      app.appendChild(node);
    }

    function renderSignup() {
      app.innerHTML = "";
      const node = el(`
        <div>
          <div class="header"><h1>æ–°è¦ç™»éŒ²</h1></div>
          <div class="card">
            <div class="card-title">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</div>
            <p class="card-subtitle">ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ ã¨PINã‚³ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚PINã¯å¿˜ã‚Œãªã„ã§ã€‚</p>

            <div class="input-group">
              <label class="input-label">ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ </label>
              <input id="nick" maxlength="20" placeholder="ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ ã‚’å…¥åŠ›" />
            </div>

            <div class="input-group">
  <label class="input-label">éƒ¨å±‹ç•ªå·</label>
  <input id="room" maxlength="10" placeholder="ä¾‹ï¼š203 / A-12 ãªã©" />
</div>

            
            <div class="input-group">
              <label class="input-label">PINã‚³ãƒ¼ãƒ‰ï¼ˆ4æ¡ï¼‰</label>
              <input id="pin" type="password" inputmode="numeric" maxlength="4" placeholder="4æ¡ã®æ•°å­—" />
            </div>

            <button id="btn" type="button">ç™»éŒ²ã—ã¦é–‹å§‹</button>
            <div id="msg"></div>

            <div class="divider"></div>
            <p class="text-center text-muted">
              ã™ã§ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®æ–¹ã¯<br>
              <a href="#/login" class="link">ãƒ­ã‚°ã‚¤ãƒ³</a>
            </p>
          </div>
        </div>
      `);

      node.querySelector("#btn").onclick = async () => {
        const nick = node.querySelector("#nick").value.trim();
        const pin  = node.querySelector("#pin").value.trim();
        const msg  = node.querySelector("#msg");
        const btn  = node.querySelector("#btn");
        const room = node.querySelector("#room").value.trim();

        msg.innerHTML = "";
        if (!room) {
  msg.innerHTML = '<div class="alert alert-error">éƒ¨å±‹ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
  node.classList.add("shake");
  setTimeout(() => node.classList.remove("shake"), 300);
  return;
}

        if (!nick) { msg.innerHTML = '<div class="alert alert-error">ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>'; node.classList.add("shake"); setTimeout(()=>node.classList.remove("shake"),300); return; }
        if (!/^[0-9]{4}$/.test(pin)) { msg.innerHTML = '<div class="alert alert-error">PINã‚³ãƒ¼ãƒ‰ã¯4æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>'; node.classList.add("shake"); setTimeout(()=>node.classList.remove("shake"),300); return; }

        btn.disabled = true;
        btn.textContent = "ç™»éŒ²ä¸­...";

        try {
          const { error } = await sb.rpc("register_player", { nick, pin, room });

          if (error) throw error;
          msg.innerHTML = '<div class="alert alert-success">âœ“ ç™»éŒ²å®Œäº†</div>';
          setTimeout(() => location.hash = "#/", 400);
        } catch (e) {
          msg.innerHTML = `<div class="alert alert-error">ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ<br>${e?.message ?? "åŒã˜ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"}</div>`;
          node.classList.add("shake");
          setTimeout(()=>node.classList.remove("shake"),300);
        } finally {
          btn.disabled = false;
          btn.textContent = "ç™»éŒ²ã—ã¦é–‹å§‹";
        }
      };

      app.appendChild(node);
    }

    function renderCheckpoint(nickname, prog, target) {
      app.innerHTML = "";
      const locked = prog.checkpoint < target - 1;

      const node = el(`
        <div>
          <div class="header">
            <h1>ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ</h1>
            <div class="badge">ğŸ“ ${prog.checkpoint}/${MAX_CHECKPOINT}</div>
          </div>

          <div class="checkpoint-card">
            <div class="checkpoint-number">${target}</div>
            <div>CHECKPOINT ${target}</div>
          </div>

          <div class="card">
            ${locked ? `
              <div class="alert alert-error">ğŸ”’ ãƒ­ãƒƒã‚¯ä¸­ï¼šå…ˆã«CP${target - 1}ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã­</div>
            ` : `
              <div class="card-title">ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆåˆ°é”</div>
              <p class="card-subtitle">åˆ°é”ã—ãŸäººã ã‘é€²æ—ã‚’æ›´æ–°ã§ãã¾ã™</p>
                        <div class="input-group" style="margin-top:12px;">
  <label class="input-label">åˆè¨€è‘‰</label>
  <input id="pass" maxlength="30" placeholder="QRã®ä¸‹ã®åˆè¨€è‘‰ã‚’å…¥åŠ›" />
</div>
              <button id="claim" type="button">âœ“ åˆ°é”ã‚’ç¢ºèª</button>
            `}

            <div id="msg"></div>

            <div id="hint" style="display:none;">
              <div class="alert alert-success"><strong>ã‚¯ãƒªã‚¢ï¼</strong><br>æ¬¡ã®ãƒ’ãƒ³ãƒˆãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸ</div>
              <div class="hint-box">
                <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ ${target}</strong><br>
                ${hintText(target)}
              </div>
              <button class="btn-secondary" type="button" onclick="location.hash='#/'">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
            </div>
          </div>
        </div>
      `);

      if (!locked) {
node.querySelector("#claim").onclick = async () => {
  const btn = node.querySelector("#claim");
  const msg = node.querySelector("#msg");
  msg.innerHTML = "";

  btn.disabled = true;
  btn.textContent = "ç¢ºèªä¸­...";

  const pass = node.querySelector("#pass").value; // â˜…è¿½åŠ ï¼šåˆè¨€è‘‰

  try {
    const me = await getMe();
    const res = await advanceIfAllowed(me.id, target, pass);

    if (!res.ok) {
      if (res.reason === "no_passphrase") {
        msg.innerHTML = `<div class="alert alert-error">åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>`;
      } else if (res.reason === "invalid_passphrase") {
        msg.innerHTML = `<div class="alert alert-error">åˆè¨€è‘‰ãŒé•ã„ã¾ã™</div>`;
      } else if (res.reason === "wrong_order") {
        msg.innerHTML = `<div class="alert alert-error">é †ç•ªãŒé•ã„ã¾ã™ã€‚ç¾åœ¨ã¯ ${res.current} / ${MAX_CHECKPOINT} ã§ã™</div>`;
      } else {
        msg.innerHTML = `<div class="alert alert-error">å¤±æ•—ï¼š${res.message ?? "ã‚¨ãƒ©ãƒ¼"}</div>`;
      }
      btn.disabled = false;
      btn.textContent = "âœ“ åˆ°é”ã‚’ç¢ºèª";
      return;
    }

    // æˆåŠŸï¼šãƒ’ãƒ³ãƒˆè¡¨ç¤º
    node.querySelector("#hint").style.display = "block";
    btn.style.display = "none";

    // æœ€çµ‚ãªã‚‰ã‚¯ãƒªã‚¢ç”»é¢ã¸ï¼ˆå›ãŒ #/clear ã‚’ä½œã£ã¦ã‚‹å‰æï¼‰
    if (target === MAX_CHECKPOINT) {
      setTimeout(() => location.hash = "#/clear", 600);
    }

  } catch (e) {
    msg.innerHTML = `<div class="alert alert-error">ã‚¨ãƒ©ãƒ¼ï¼š${e?.message ?? e}</div>`;
    btn.disabled = false;
    btn.textContent = "âœ“ åˆ°é”ã‚’ç¢ºèª";
  }
};


      app.appendChild(node);
    }

    function renderTrap(nickname, prog, reason = "") {
  app.innerHTML = "";

  const lines = [
    "ã“ã“ã«ã¯ä½•ã‚‚ãªã„ã€‚",
    "é †ç•ªã‚’é£›ã°ã—ã¦ã‚‚ã€é€²æ—ã¯é€²ã¾ãªã„ã€‚",
    "æ¨æ¸¬ã—ãŸï¼Ÿãã®æƒ…ç†±ã€æ­£è¦ãƒ«ãƒ¼ãƒˆã«ä½¿ã£ã¦ãã‚Œã€‚",
    "BearsRockã¯åºƒã„ã€‚ãƒ’ãƒ³ãƒˆã¯è¿‘ã„ã€‚",
  ];
  const msg = lines[Math.floor(Math.random() * lines.length)];

  app.appendChild(el(`
    <div>
      <div class="header">
        <h1 class="flicker">ğŸ˜ˆ ãƒã‚ºãƒ¬</h1>
      </div>

      <div class="card trapCard">
        <div style="display:flex;align-items:center;gap:12px;">
          <div class="trapSkull">ğŸ’€</div>
          <div>
            <div class="glitch" data-text="TRAP">TRAP</div>
            <div class="text-muted" style="margin-top:6px;">${msg}</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="smallHint">
          <div>âœ… æ­£è§£QRã¯ã€Œ4ã¤ã®URLã ã‘ã€ã§ã™ã€‚</div>
          <div>ğŸ”’ æ¨æ¸¬URLã¯å…¨éƒ¨ãƒã‚ºãƒ¬ã«ãªã‚Šã¾ã™ã€‚</div>
          ${reason ? `<div style="opacity:.7;margin-top:6px;">debug: ${reason}</div>` : ``}
        </div>

        <div style="margin-top:16px;">
          <button type="button" onclick="location.hash='#/'">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
        </div>
      </div>
    </div>
  `));
}
ã€€function renderClear(nickname) {
  app.innerHTML = "";
  app.appendChild(el(`
    <div>
      <div class="header">
        <h1>ğŸ‰ ã‚¯ãƒªã‚¢ï¼</h1>
      </div>

      <div class="card">
        <div class="card-title">ãŠã‚ã§ã¨ã†ã€${nickname}ï¼</div>
        <p class="card-subtitle">
          å…¨ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚<br>
          ã—ã°ã‚‰ãã™ã‚‹ã¨ã‚ãªãŸã®éƒ¨å±‹ã®å‰ã«æ™¯å“ãŒå±Šãã¾ã™ã€‚
        </p>

        <div class="hint-box">
          <strong>ğŸ æ™¯å“</strong><br>
          é£Ÿå ‚ãƒã‚±ãƒƒãƒˆ
        </div>

        <div class="divider"></div>

        <button onclick="location.hash='#/me'">ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚‹</button>
        <button class="btn-secondary" onclick="location.hash='#/'" style="margin-top:12px;">ãƒ›ãƒ¼ãƒ ã¸</button>
      </div>
    </div>
  `));
}


    function renderScan(nickname, prog) {
  app.innerHTML = "";

  const isIOS =
    /iPad|iPhone|iPod/.test(navigator.userAgent) ||
    (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1); // iPadOSå¯¾ç­–

  const node = el(`
    <div>
      <div class="header">
        <h1>ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³</h1>
        <div class="badge">ğŸ“ CP ${prog.checkpoint}/${MAX_CHECKPOINT}</div>
      </div>

      <div class="card">
        <div class="card-title">QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</div>

        ${
          isIOS
            ? `
              <div class="alert alert-success">
                iPhoneã®æ–¹ã¯ã€æ¨™æº–ã‚«ãƒ¡ãƒ©ã§QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„
              </div>
              <p class="card-subtitle">
                QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹ã¨Safariã§ãƒšãƒ¼ã‚¸ãŒé–‹ãã¾ã™ã€‚<br>
                é–‹ã„ãŸç”»é¢ã§ã€Œåˆ°é”ç¢ºèªã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
              </p>
            `
            : `
              <p class="card-subtitle">ã‚«ãƒ¡ãƒ©ã§QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã¾ã™</p>
              <video id="v" playsinline></video>

              <div class="button-group">
                <button id="start" type="button">ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
                <button id="stop" type="button" disabled>åœæ­¢</button>
              </div>

              <div id="msg"></div>
            `
        }
      </div>
    </div>
  `);

  // iPhoneã¯æ¡ˆå†…ã®ã¿ã§çµ‚äº†
  if (isIOS) {
    app.appendChild(node);
    return;
  }

  // Android / å¯¾å¿œç«¯æœ«ã®ã¿ãƒ–ãƒ©ã‚¦ã‚¶å†…ã‚¹ã‚­ãƒ£ãƒ³
  const v = node.querySelector("#v");
  const startBtn = node.querySelector("#start");
  const stopBtn = node.querySelector("#stop");
  const msg = node.querySelector("#msg");

  let stream = null;
  let raf = null;

  const stopCamera = () => {
    if (raf) cancelAnimationFrame(raf);
    raf = null;
    if (stream) stream.getTracks().forEach(t => t.stop());
    stream = null;
    v.srcObject = null;
    stopBtn.disabled = true;
    startBtn.disabled = false;
  };

  const openResult = (text) => {
    if (text.includes("#/")) {
      location.href = text;
      return;
    }
    msg.innerHTML = `<div class="alert alert-error">æœ‰åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
  };

  startBtn.onclick = async () => {
    msg.innerHTML = "";
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false
      });
      v.srcObject = stream;
      await v.play();

      startBtn.disabled = true;
      stopBtn.disabled = false;

      if (!("BarcodeDetector" in window)) {
        msg.innerHTML = `<div class="alert alert-error">
          ã“ã®ç«¯æœ«ã¯è‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³éå¯¾å¿œã§ã™ã€‚<br>
          æ¨™æº–ã‚«ãƒ¡ãƒ©ã§QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚
        </div>`;
        return;
      }

      const det = new BarcodeDetector({ formats: ["qr_code"] });

      const tick = async () => {
        try {
          const barcodes = await det.detect(v);
          if (barcodes?.[0]?.rawValue) {
            stopCamera();
            openResult(barcodes[0].rawValue);
            return;
          }
        } catch {}
        raf = requestAnimationFrame(tick);
      };
      tick();

    } catch (e) {
      msg.innerHTML = `<div class="alert alert-error">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>`;
      stopCamera();
    }
  };

  stopBtn.onclick = () => stopCamera();

  app.appendChild(node);
}


    function renderMe(nickname, prog) {
      app.innerHTML = "";

      let hintsHtml = "";
      for (let i = 1; i <= prog.checkpoint; i++) {
        hintsHtml += `
          <div class="list-item">
            <div>
              <strong>ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ ${i}</strong>
              <div class="text-muted" style="font-size:14px;margin-top:4px;">${hintText(i)}</div>
            </div>
            <div style="font-size:20px;">âœ…</div>
          </div>
        `;
      }
      if (!hintsHtml) hintsHtml = `<p class="text-muted">ã¾ã ãƒ’ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;

      app.appendChild(el(`
        <div>
          <div class="header"><h1>ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</h1></div>

          <div class="card">
            <div class="card-title">${nickname}</div>
            <div class="stats">
              <div class="stat-item">
                <div class="stat-value">${prog.checkpoint}</div>
                <div class="stat-label">ã‚¯ãƒªã‚¢æ¸ˆã¿</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${progressPercent(prog.checkpoint)}%</div>
                <div class="stat-label">é”æˆç‡</div>
              </div>
            </div>
            <div class="progress-container">
              <div class="progress-bar" style="width:${progressPercent(prog.checkpoint)}%"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-title">è§£æ”¾æ¸ˆã¿ãƒ’ãƒ³ãƒˆ</div>
            <div style="margin-top:16px;">${hintsHtml}</div>
          </div>
        </div>
      `));
    }

    async function renderLeaderboard(nickname) {
      app.innerHTML = "";
      app.appendChild(el(`
        <div>
          <div class="header"><h1>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h1></div>
          <div class="card">
            <div class="card-title">é€²æ—ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
            <p class="card-subtitle">é€²æ—ãŒé«˜ã„é †ã€‚åŒç‡ã®å ´åˆã¯åˆ°é”ãŒæ—©ã„é †</p>
            <div id="list"></div>
          </div>
        </div>
      `));

      const list = document.getElementById("list");
      list.innerHTML = `<p class="text-muted text-center">èª­ã¿è¾¼ã¿ä¸­...</p>`;

      try {
        const { data, error } = await sb.rpc("get_leaderboard");
        if (error) throw error;

        if (!data?.length) {
          list.innerHTML = `<p class="text-muted text-center">ã¾ã èª°ã‚‚ã„ã¾ã›ã‚“</p>`;
          return;
        }

        list.innerHTML = data.map((r, idx) => {
  const isMe = (r.nickname === nickname);

  // ä¸Šä½3ä½ã®ã‚¯ãƒ©ã‚¹ï¼ˆé †ä½ç•ªå·ã‚’é‡‘éŠ€éŠ…ã«ï¼‰
  const topClass = idx === 0 ? "rank-1" : idx === 1 ? "rank-2" : idx === 2 ? "rank-3" : "";

  // 4/4 ã®äººã ã‘ ğŸ‰ï¼ˆMAX_CHECKPOINT ã‚’ä½¿ã†ï¼‰
  const isClear = (r.checkpoint >= MAX_CHECKPOINT);

  // è¡¨è¨˜ã¯ 3 / 4
  const progressText = `${r.checkpoint} / ${MAX_CHECKPOINT}`;

  return `
    <div class="list-item ${isMe ? "active" : ""} ${topClass}">
      <div style="display:flex;align-items:center;gap:12px;flex:1;">
        <div class="rank-number">#${idx + 1}</div>

        <div style="display:flex;align-items:center;flex-wrap:wrap;">
          <strong>${r.nickname}</strong>
          ${isMe ? `<span class="me-badge">ã‚ãªãŸ</span>` : ``}
        </div>
      </div>

      <div class="finish">
        <span>${progressText}</span>
        ${isClear ? `<span class="done">ğŸ‰</span>` : ``}
      </div>
    </div>
  `;
}).join("");

      } catch (e) {
        list.innerHTML = `<div class="alert alert-error">å–å¾—å¤±æ•—ï¼š${e?.message ?? e}</div>`;
      }
    }

    async function route() {
      setNavActive();
      await ensureAnonLogin();

      const r = getRoute();
 if (r.type === "intro") {
    renderIntro();
    return;
  }
      
      // âœ… ä¸æ˜URLã¯ãƒã‚ºãƒ¬
if (r.type === "unknown") {
  renderTrap("GUEST", { checkpoint: 0 }, "UNKNOWN");
  return;
}

// âœ… CP URLã¯ã€Œã“ã®4ã¤ã ã‘è¨±å¯ã€
// ä¾‹ï¼š#/c/1-f8K3 ã¯OKã€#/c/1-aaaa ã¯ãƒã‚ºãƒ¬
if (r.type === "cp") {
  if (r.type === "unknown") {
  location.hash = "#/c/999-TRAP";
  return;
}

  // trapã¯ 999-TRAP ã ã‘è¨±å¯
  if (r.n === 999) {
    if (r.key === TRAP_KEY) {
      renderTrap("GUEST", { checkpoint: 0 }, "TRAP");
      return;
    } else {
      renderTrap("GUEST", { checkpoint: 0 }, "TRAP_KEY_MISMATCH");
      return;
    }
  }

  // æ­£è§£CPã¯ 1..4 ã§ã€ã‚­ãƒ¼ãŒä¸€è‡´ã—ãŸæ™‚ã ã‘é€šã™
  if (!CP_KEYS[r.n] || r.key !== CP_KEYS[r.n]) {
    renderTrap("GUEST", { checkpoint: 0 }, "KEY_MISMATCH");
    return;
  }
}

      // route() ã®ä¸­
if (r.type === "unknown") {
  renderTrap("GUEST", { checkpoint: 0 });
  return;
}

if (r.type === "cp" && r.n === 999) {
  renderTrap("GUEST", { checkpoint: 0 });
  return;
}

            const me = await getMe();
      const nick = await getNickname(me.id);
      const prog = nick ? await getProgress(me.id) : { checkpoint: 0, updated_at: null };

      // âœ…ãƒ­ã‚°ã‚¤ãƒ³å‰ã«é–‹ã‹ã›ãªã„ï¼ˆã“ã“ãŒå¤§äº‹ï¼‰
      if (!nick && (r.type === "scan" || r.type === "leaderboard" || r.type === "me" || r.type === "home" || r.type === "cp")) {
        location.hash = "#/login";
        return;
      }

      if (r.type === "clear") {
        renderClear(nick);
        return;
      }

      if (r.type === "login") { renderLogin(); return; }
      if (r.type === "signup") { renderSignup(); return; }

      if (r.type === "home") { renderHome(nick, prog); return; }
      if (r.type === "scan") { renderScan(nick, prog); return; }
      if (r.type === "me") { renderMe(nick, prog); return; }
      if (r.type === "leaderboard") { await renderLeaderboard(nick); return; }

      if (r.type === "cp") {
        if (r.n === 999) { renderTrap(); return; }
        renderCheckpoint(nick, prog, r.n);
        return;
      }

      location.hash = "#/login";
    } catch (e) {
      // ã“ã“ãŒã‚ã‚‹ã¨ã€ŒçœŸã£ç™½ã€ã«ãªã‚‰ãšåŸå› ãŒè¦‹ãˆã‚‹
      app.innerHTML = `
        <div class="card">
          <div class="card-title">ã‚¨ãƒ©ãƒ¼ã§åœæ­¢ã—ã¾ã—ãŸ</div>
          <div class="alert alert-error" style="margin-top:12px;">
            ${e?.message ?? e}
          </div>
        </div>
      `;
      console.error(e);
    }
  }

  window.addEventListener("hashchange", route);

  if (!location.hash) location.hash = "#/intro";
  route();

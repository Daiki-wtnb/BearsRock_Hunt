<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dorm QR Hunt</title>
  <style>
  :root{
    --bg1:#0b1020;
    --bg2:#120a2a;
    --card: rgba(255,255,255,.08);
    --line: rgba(255,255,255,.18);
    --text: rgba(255,255,255,.92);
    --muted: rgba(255,255,255,.65);
    --bad:#ff5a7a;
    --good:#45f08a;
    --accent:#7aa7ff;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif;
    background:
      radial-gradient(1200px 800px at 20% 10%, rgba(122,167,255,.20), transparent 60%),
      radial-gradient(900px 700px at 90% 20%, rgba(255,90,122,.18), transparent 60%),
      radial-gradient(900px 700px at 40% 90%, rgba(69,240,138,.14), transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
    padding: 22px;
  }
  body:before{
    content:"";
    position:fixed; inset:0;
    pointer-events:none;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.12'/%3E%3C/svg%3E");
    mix-blend-mode: overlay;
    opacity:.5;
  }

  .shell{ max-width: 860px; margin: 0 auto; }
  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom: 14px;
    gap: 10px;
  }
  .brand{
    font-weight:800;
    letter-spacing:.02em;
    font-size: 1.05rem;
    opacity:.95;
  }
  .tag{
    display:inline-flex; gap:8px; align-items:center;
    padding:8px 12px;
    border:1px solid var(--line);
    border-radius:999px;
    background: rgba(0,0,0,.18);
    backdrop-filter: blur(10px);
    color: var(--muted);
    font-size:.9rem;
  }

  .card{
    border:1px solid var(--line);
    background: linear-gradient(180deg, var(--card), rgba(0,0,0,.18));
    border-radius: 20px;
    padding: 18px;
    backdrop-filter: blur(14px);
    box-shadow: 0 18px 60px rgba(0,0,0,.35);
  }
  h1{ margin: 0 0 10px; font-size: 1.45rem; }
  h2{ margin: 10px 0 6px; font-size: 1.2rem; }
  p{ margin: 8px 0; color: var(--muted); }

  .row{ display:grid; gap: 12px; }
  .pillset{ display:flex; gap:10px; flex-wrap: wrap; }

  input{
    width:100%;
    padding: 13px 14px;
    border-radius: 14px;
    border:1px solid var(--line);
    background: rgba(0,0,0,.20);
    color: var(--text);
    outline:none;
  }
  input:focus{
    border-color: rgba(122,167,255,.65);
    box-shadow: 0 0 0 4px rgba(122,167,255,.15);
  }

  button{
    width:100%;
    padding: 13px 14px;
    border-radius: 14px;
    border:1px solid rgba(122,167,255,.65);
    background: linear-gradient(180deg, rgba(122,167,255,.35), rgba(122,167,255,.10));
    color: var(--text);
    font-weight: 800;
    letter-spacing:.02em;
    cursor:pointer;
    transition: transform .06s ease, filter .15s ease, opacity .15s ease;
  }
  button:hover{ filter: brightness(1.12); }
  button:active{ transform: translateY(1px) scale(.99); }
  button:disabled{
    opacity:.45;
    cursor:not-allowed;
    border-color: var(--line);
    background: rgba(0,0,0,.12);
  }

  a{ color: var(--text); }
  .linkbtn{
    display:inline-flex;
    padding:10px 12px;
    border-radius: 12px;
    border:1px solid var(--line);
    color: var(--text);
    text-decoration:none;
    background: rgba(0,0,0,.16);
  }

  .msg-bad{ color: var(--bad); font-weight:700; }
  .msg-good{ color: var(--good); font-weight:800; }

  .progressWrap{
    border:1px solid var(--line);
    background: rgba(0,0,0,.18);
    border-radius: 999px;
    padding: 6px;
  }
  .bar{
    height: 10px;
    border-radius: 999px;
    width: 0%;
    background: linear-gradient(90deg, rgba(69,240,138,.85), rgba(122,167,255,.85));
    transition: width .35s ease;
  }

  .shake{ animation: shake .25s linear 0s 2; }
  @keyframes shake{
    0%{ transform: translateX(0); }
    25%{ transform: translateX(-4px); }
    50%{ transform: translateX(4px); }
    75%{ transform: translateX(-3px); }
    100%{ transform: translateX(0); }
  }
  </style>
</head>

<body>
  <div class="shell">
    <div class="topbar">
      <div class="brand">ğŸ BEARSROCK HUNT</div>
      <div class="tag">QRã‚¹ã‚­ãƒ£ãƒ³ã§é€²è¡Œ</div>
    </div>

    <div class="card">
      <h1>å¯®å†…QRãƒãƒ³ãƒˆ</h1>
      <div id="app"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // =========================
    // è¨­å®š
    // =========================
    const SUPABASE_URL = "https://ahynlwtcdrtkzykcccgb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoeW5sd3RjZHJ0a3p5a2NjY2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MTA0MDQsImV4cCI6MjA4Mjk4NjQwNH0.HttRXUS-Qy6VA0t4UE8MIC58tgncg-2bucYfLr14LSA";

    // é€²æ—ãƒãƒ¼ã®æœ€å¤§ï¼ˆcheckpointã®æ•°ã«åˆã‚ã›ã¦å¤‰æ›´ï¼‰
    const MAX_CHECKPOINT = 4;

    // =========================
    // Supabase æ¥ç¶š
    // =========================
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    // =========================
    // DOMãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // =========================
    const app = document.getElementById("app");

    const el = (html) => {
      const d = document.createElement("div");
      d.innerHTML = html.trim();
      return d.firstChild;
    };

    const progressPercent = (current, max = MAX_CHECKPOINT) => {
      const v = Math.max(0, Math.min(current, max));
      return Math.round((v / max) * 100);
    };

    // =========================
    // ãƒ«ãƒ¼ãƒˆï¼ˆãƒšãƒ¼ã‚¸åˆ†ã‘ï¼‰
    // =========================
    const getCheckpointFromHash = () => {
      const m = location.hash.match(/^#\/c\/(\d+)$/);
      return m ? parseInt(m[1], 10) : null;
    };

    const getRoute = () => {
      if (location.hash.startsWith("#/c/")) return { type: "cp", n: getCheckpointFromHash() };
      if (location.hash === "#/login") return { type: "login" };
      if (location.hash === "#/signup") return { type: "signup" };
      if (location.hash === "#/" || location.hash === "" || location.hash === "#") return { type: "home" };
      return { type: "login" };
    };

    // =========================
    // èªè¨¼ï¼ˆåŒ¿åï¼‰
    // =========================
    async function ensureAnonLogin() {
      const { data: { session } } = await sb.auth.getSession();
      if (session) return session;

      const { data, error } = await sb.auth.signInAnonymously();
      if (error) throw error;
      return data.session;
    }

    async function getMe() {
      const { data: { user } } = await sb.auth.getUser();
      return user;
    }

    // =========================
    // DBæ“ä½œ
    // =========================
    async function getNickname(user_id) {
      const { data, error } = await sb
        .from("players")
        .select("nickname")
        .eq("user_id", user_id)
        .maybeSingle();
      if (error) throw error;
      return data?.nickname ?? null;
    }

    async function getProgress(user_id) {
      const { data, error } = await sb
        .from("progress")
        .select("checkpoint, updated_at")
        .eq("user_id", user_id)
        .maybeSingle();
      if (error) throw error;
      return data ?? { checkpoint: 0, updated_at: null };
    }

    // æ–¹å¼1ï¼šcurrent+1 ã®æ™‚ã ã‘é€²ã‚ã‚‹
    async function advanceIfAllowed(user_id, targetCheckpoint) {
      const current = await getProgress(user_id);

      if (targetCheckpoint !== current.checkpoint + 1) {
        return { ok: false, current: current.checkpoint };
      }

      const { error } = await sb
        .from("progress")
        .update({ checkpoint: targetCheckpoint })
        .eq("user_id", user_id);

      if (error) throw error;
      return { ok: true, current: targetCheckpoint };
    }

    // =========================
    // æ–‡ç« ï¼ˆã“ã“ã ã‘å¥½ãã«å¤‰ãˆã‚‹ï¼‰
    // =========================
    function hintText(n) {
      const hints = {
        1: "ãƒ’ãƒ³ãƒˆ1ï¼šæ¯æœã€é´ãŒé›†ã¾ã‚‹å ´æ‰€ã®â€œä¸Šâ€ã‚’è¦‹ã‚ã€‚",
        2: "ãƒ’ãƒ³ãƒˆ2ï¼šæ´—æ¿¯ã®éŸ³ãŒã™ã‚‹å ´æ‰€ã€‚ãã“ã«æ¬¡ãŒã‚ã‚‹ã€‚",
        3: "ãƒ’ãƒ³ãƒˆ3ï¼šã¿ã‚“ãªãŒé›†ã¾ã‚‹æ²ç¤ºæ¿ã®è¿‘ãã‚’æ¢ã›ã€‚",
        4: "æœ€çµ‚ï¼šé£Ÿå ‚ã¸ã€‚ã‚¯ãƒªã‚¢ç”»é¢ã‚’è¦‹ã›ã¦æ™¯å“ã‚²ãƒƒãƒˆï¼"
      };
      return hints[n] ?? "ï¼ˆã“ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã®æ–‡ã‚’è¿½åŠ ã—ã¦ã­ï¼‰";
    }

    // =========================
    // ç”»é¢ï¼ˆUIï¼‰
    // =========================
    function renderHome(nickname, prog) {
      app.innerHTML = "";
      app.appendChild(el(`
        <div class="row">
          <div class="pillset">
            <span class="tag">ğŸ‘¤ ${nickname}</span>
            <span class="tag">ğŸ“ é€²æ— ${prog.checkpoint}</span>
          </div>

          <div class="progressWrap" aria-label="progress">
            <div class="bar" style="width:${progressPercent(prog.checkpoint)}%"></div>
          </div>

          <p>QRã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦é€²ã‚“ã§ãã ã•ã„ã€‚</p>

          <p class="muted">
            ãƒ†ã‚¹ãƒˆç”¨ãƒªãƒ³ã‚¯ï¼ˆæœ¬ç•ªã¯QRã«å…¥ã‚Œã‚‹ï¼‰ï¼š<br>
            <a href="#/c/1">CP1</a> /
            <a href="#/c/2">CP2</a> /
            <a href="#/c/3">CP3</a> /
            <a href="#/c/4">CP4</a> /
            <a href="#/c/999">TRAP</a>
          </p>
        </div>
      `));
    }

    function renderLogin() {
      app.innerHTML = "";

      const node = el(`
        <div class="row">
          <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
          <p class="muted">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨PINï¼ˆ4æ¡ï¼‰ã§ç¶šãã‹ã‚‰å†é–‹ã—ã¾ã™ã€‚</p>

          <input id="nick" maxlength="20" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " />
          <input id="pin" inputmode="numeric" maxlength="4" placeholder="PINï¼ˆ4æ¡ï¼‰" />
          <button id="btn">ãƒ­ã‚°ã‚¤ãƒ³</button>

          <p id="msg" class="msg-bad"></p>

          <p class="muted">
            ã¯ã˜ã‚ã¦ã®æ–¹ã¯ <a class="linkbtn" href="#/signup">æ–°è¦ç™»éŒ²ã¯ã“ã¡ã‚‰</a>
          </p>
        </div>
      `);

      node.querySelector("#btn").onclick = async () => {
        const nick = node.querySelector("#nick").value.trim();
        const pin  = node.querySelector("#pin").value.trim();
        const msg  = node.querySelector("#msg");
        msg.textContent = "";

        if (!nick) { msg.textContent = "ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥ã‚Œã¦"; node.classList.add("shake"); setTimeout(()=>node.classList.remove("shake"),400); return; }
        if (!/^[0-9]{4}$/.test(pin)) { msg.textContent = "PINã¯4æ¡ã®æ•°å­—ã«ã—ã¦"; node.classList.add("shake"); setTimeout(()=>node.classList.remove("shake"),400); return; }

        try {
          // âœ… Supabaseã«ä½œã£ãŸé–¢æ•°ï¼ˆSQLï¼‰ã‚’å‘¼ã¶ï¼šãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ +PINãŒæ­£ã—ã‘ã‚Œã°å¾©å¸°
          await sb.rpc("claim_player", { nick, pin });
          location.hash = "#/";
        } catch (e) {
          msg.textContent = "ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  or PIN ãŒé•ã†";
          node.classList.add("shake");
          setTimeout(()=>node.classList.remove("shake"),400);
        }
      };

      app.appendChild(node);
    }

    function renderSignup() {
      app.innerHTML = "";

      const node = el(`
        <div class="row">
          <h2>æ–°è¦ç™»éŒ²</h2>
          <p class="muted">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨PINï¼ˆ4æ¡ï¼‰ã‚’è¨­å®šã—ã¾ã™ã€‚PINã¯å¿˜ã‚Œã‚‹ã¨å¾©å¸°ã§ãã¾ã›ã‚“ã€‚</p>

          <input id="nick" maxlength="20" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " />
          <input id="pin" inputmode="numeric" maxlength="4" placeholder="PINï¼ˆ4æ¡ï¼‰" />
          <button id="btn">ç™»éŒ²ã—ã¦é–‹å§‹</button>

          <p id="msg" class="msg-bad"></p>

          <p class="muted">
            ã™ã§ã«ç™»éŒ²æ¸ˆã¿ãªã‚‰ <a class="linkbtn" href="#/login">ãƒ­ã‚°ã‚¤ãƒ³ã¯ã“ã¡ã‚‰</a>
          </p>
        </div>
      `);

      node.querySelector("#btn").onclick = async () => {
        const nick = node.querySelector("#nick").value.trim();
        const pin  = node.querySelector("#pin").value.trim();
        const msg  = node.querySelector("#msg");
        msg.textContent = "";

        if (!nick) { msg.textContent = "ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥ã‚Œã¦"; node.classList.add("shake"); setTimeout(()=>node.classList.remove("shake"),400); return; }
        if (!/^[0-9]{4}$/.test(pin)) { msg.textContent = "PINã¯4æ¡ã®æ•°å­—ã«ã—ã¦"; node.classList.add("shake"); setTimeout(()=>node.classList.remove("shake"),400); return; }

        try {
          // âœ… Supabaseã«ä½œã£ãŸé–¢æ•°ï¼ˆSQLï¼‰ã‚’å‘¼ã¶ï¼šæ–°è¦ç™»éŒ²
          await sb.rpc("register_player", { nick, pin });
          location.hash = "#/";
        } catch (e) {
          msg.textContent = "ç™»éŒ²ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆåŒã˜ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ãŒæ—¢ã«ã‚ã‚‹ã‹ã‚‚ï¼‰";
          node.classList.add("shake");
          setTimeout(()=>node.classList.remove("shake"),400);
        }
      };

      app.appendChild(node);
    }

    function renderCheckpoint(nickname, prog, target) {
      app.innerHTML = "";

      const locked = prog.checkpoint < target - 1;

      const node = el(`
        <div class="row">
          <div class="pillset">
            <span class="tag">ğŸ‘¤ ${nickname}</span>
            <span class="tag">ğŸ“ é€²æ— ${prog.checkpoint}</span>
          </div>

          <div class="progressWrap" aria-label="progress">
            <div class="bar" style="width:${progressPercent(prog.checkpoint)}%"></div>
          </div>

          <h2>Checkpoint ${target}</h2>

          ${locked
            ? `<p class="msg-bad">ğŸ”’ ãƒ­ãƒƒã‚¯ä¸­ï¼šå…ˆã« checkpoint ${target - 1} ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã­ã€‚</p>`
            : `<p class="muted">ã“ã®QRã«åˆ°é”ã—ãŸäººã ã‘ã€é€²æ—ã‚’æ›´æ–°ã§ãã¾ã™ã€‚</p>`
          }

          <button id="claim" ${locked ? "disabled" : ""}>ã“ã“ã«åˆ°é”ã—ãŸï¼ˆæ¬¡ã¸é€²ã‚€ï¼‰</button>
          <p id="msg"></p>

          <div id="hint" style="display:none;">
            <p class="msg-good">OKï¼</p>
            <p>${hintText(target)}</p>
            <p><a class="linkbtn" href="#/">ãƒ›ãƒ¼ãƒ ã¸</a></p>
          </div>

          <p class="muted">ãƒã‚ºãƒ¬QRï¼š <a href="#/c/999">#/c/999</a></p>
        </div>
      `);

      node.querySelector("#claim").onclick = async () => {
        const msg = node.querySelector("#msg");
        msg.textContent = "";
        msg.className = "";

        try {
          const me = await getMe();
          const res = await advanceIfAllowed(me.id, target);

          if (!res.ok) {
            msg.className = "msg-bad";
            msg.textContent = `é †ç•ªãŒé•ã„ã¾ã™ã€‚ã‚ãªãŸã®ç¾åœ¨é€²æ—ã¯ ${res.current} ã§ã™ã€‚`;
            node.classList.add("shake");
            setTimeout(()=>node.classList.remove("shake"),400);
            return;
          }

          msg.className = "msg-good";
          msg.textContent = "é€²æ—ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼";
          node.querySelector("#hint").style.display = "block";
        } catch (e) {
          msg.className = "msg-bad";
          msg.textContent = "ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¾ã—ãŸã€‚ã‚‚ã†ä¸€å›æŠ¼ã—ã¦ã¿ã¦ã€‚";
          node.classList.add("shake");
          setTimeout(()=>node.classList.remove("shake"),400);
        }
      };

      app.appendChild(node);
    }

    function renderTrap(nickname, prog) {
      app.innerHTML = "";
      app.appendChild(el(`
        <div class="row">
          <div class="pillset">
            <span class="tag">ğŸ‘¤ ${nickname}</span>
            <span class="tag">ğŸ“ é€²æ— ${prog.checkpoint}</span>
          </div>

          <h2>ğŸ˜ˆ ãƒã‚ºãƒ¬ï¼</h2>
          <p>æ®‹å¿µã€‚ã“ã“ã«ã¯ä½•ã‚‚ãªã„ã€‚ã ãŒå›ã®å¥½å¥‡å¿ƒã¯è©•ä¾¡ã™ã‚‹ã€‚</p>
          <p><a class="linkbtn" href="#/">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</a></p>
        </div>
      `));
    }

    // =========================
    // å¸ä»¤å¡”ï¼šã“ã“ãŒ1ã¤ã ã‘ã‚ã‚‹ã®ãŒé‡è¦
    // =========================
    async function route() {
      await ensureAnonLogin();
      const r = getRoute();

      const me = await getMe();
      const nick = await getNickname(me.id);
      const prog = nick ? await getProgress(me.id) : { checkpoint: 0, updated_at: null };

      // ãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²ã¯ã„ã¤ã§ã‚‚è¦‹ã›ã‚‹
      if (r.type === "login") { renderLogin(); return; }
      if (r.type === "signup") { renderSignup(); return; }

      // home/cp ã¯ç™»éŒ²å¿…é ˆ
      if (!nick) { location.hash = "#/login"; return; }

      if (r.type === "home") { renderHome(nick, prog); return; }
      if (r.type === "cp") {
        if (r.n === 999) { renderTrap(nick, prog); return; }
        renderCheckpoint(nick, prog, r.n);
        return;
      }

      location.hash = "#/login";
    }

    window.addEventListener("hashchange", route);
    route();
  </script>
</body>
</html>

<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="BearsRockå†…ã«éš ã•ã‚ŒãŸQRã‚³ãƒ¼ãƒ‰ã‚’æ¢ã—ã¦é€²ã‚€å®æ¢ã—ã‚²ãƒ¼ãƒ " />
  <meta name="theme-color" content="#0A84FF" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/icon-192.png" />
  <title>BearsRock Hunt</title>
  <style>
    :root {
      --primary: #0A84FF;
      --primary-light: #5AC8FA;
      --primary-soft: rgba(10, 132, 255, 0.12);
      --bg: #0B1020;
      --bg-soft: radial-gradient(circle at top, #1c2240 0, #050814 55%, #02030a 100%);
      --card: rgba(18, 22, 40, 0.96);
      --card-soft: rgba(23, 29, 52, 0.9);
      --border: rgba(255, 255, 255, 0.06);
      --text: #F9FAFB;
      --text-secondary: #9CA3AF;
      --success: #34D399;
      --error: #F97373;
      --shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
      --radius-lg: 18px;
      --radius-md: 14px;
      --transition-fast: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Hiragino Sans", "Noto Sans JP", sans-serif;
      background: var(--bg-soft);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 18px 18px 120px;
    }

    /* ===== header (ã‚¹ãƒãƒ›ã§å´©ã‚Œãªã„å¯¾ç­–å…¥ã‚Š) ===== */
    .header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      padding: 8px 2px 22px;
      gap: 14px;
      flex-wrap: wrap;
    }

    .header h1 {
      font-size: 30px;
      font-weight: 900;
      letter-spacing: -0.04em;
      flex: 1 1 auto;
      min-width: 0;
      line-height: 1.05;
      background: linear-gradient(120deg, #ffffff, #dbeafe, #93c5fd);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .header h1.truncate {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    @media (max-width: 420px) {
      .header h1 {
        font-size: 24px;
      }
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 11px;
      background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.22), transparent 65%), var(--card-soft);
      border: 1px solid rgba(148, 163, 184, 0.45);
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .04em;
      text-transform: uppercase;
      color: var(--text-secondary);
      box-shadow: 0 10px 30px rgba(15, 23, 42, .45);
      white-space: nowrap;
    }

    .badge-right {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-end;
      flex-wrap: wrap;
      flex: 0 0 auto;
    }

    /* ===== language segmented control ===== */
    .lang-seg {
      display: inline-flex;
      gap: 4px;
      padding: 4px;
      border-radius: 999px;
      background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.35), transparent 60%), rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.75);
      max-width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      backdrop-filter: blur(18px);
    }

    .lang-seg button {
      width: auto;
      padding: 7px 11px;
      border-radius: 999px;
      border: 0;
      background: transparent;
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 900;
      cursor: pointer;
      box-shadow: none;
      transition: all var(--transition-fast);
      flex: 0 0 auto;
    }

    .lang-seg button:hover {
      opacity: .9;
      transform: translateY(-1px) scale(1.02);
    }

    .lang-seg button.active {
      background: linear-gradient(120deg, var(--primary), var(--primary-light));
      color: #fff;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.6);
    }

    .card {
      position: relative;
      background:
        radial-gradient(circle at top left, rgba(59, 130, 246, 0.16), transparent 60%),
        radial-gradient(circle at bottom right, rgba(14, 165, 233, 0.12), transparent 65%),
        var(--card);
      border-radius: var(--radius-lg);
      padding: 20px 18px 18px;
      margin-bottom: 18px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      backdrop-filter: blur(18px);
      overflow: hidden;
    }

    .card-title {
      font-size: 19px;
      font-weight: 900;
      margin-bottom: 8px;
      letter-spacing: -0.03em;
    }

    .card-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 16px;
      line-height: 1.7;
    }

    .stats {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-item {
      flex: 1;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.4));
      padding: 12px;
      border-radius: var(--radius-md);
      text-align: center;
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .stat-value {
      font-size: 24px;
      font-weight: 900;
      color: var(--primary-light);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-secondary);
      font-weight: 800;
      letter-spacing: .12em;
      text-transform: uppercase;
    }

    .progress-container {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      height: 9px;
      overflow: hidden;
      margin: 12px 0 16px;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--primary-light));
      border-radius: 999px;
      transition: width 0.35s ease-out;
      box-shadow: 0 0 0 1px rgba(96, 165, 250, 0.4),
        0 0 18px rgba(59, 130, 246, 0.75);
    }

    .input-group {
      margin-bottom: 14px;
    }

    .input-label {
      display: block;
      font-size: 14px;
      font-weight: 800;
      margin-bottom: 7px;
      color: var(--text);
    }

    input {
      width: 100%;
      padding: 14px 14px;
      border: 1px solid rgba(148, 163, 184, 0.38);
      border-radius: var(--radius-md);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.95));
      color: var(--text);
      font-size: 15px;
      outline: none;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast),
        background var(--transition-fast),
        transform var(--transition-fast);
    }

    input::placeholder {
      color: rgba(148, 163, 184, 0.8);
    }

    input:focus {
      border-color: rgba(96, 165, 250, 0.9);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.8),
        0 0 0 8px rgba(37, 99, 235, 0.22);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.98));
      transform: translateY(-1px);
    }

    button {
      width: 100%;
      padding: 15px 14px;
      border: none;
      border-radius: var(--radius-md);
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      font-size: 15px;
      font-weight: 900;
      cursor: pointer;
      transition: transform var(--transition-fast),
        box-shadow var(--transition-fast),
        opacity var(--transition-fast),
        filter var(--transition-fast);
      box-shadow: 0 16px 35px rgba(37, 99, 235, 0.6);
      transform-origin: center;
    }

    button:hover:not(:disabled) {
      opacity: .97;
      transform: translateY(-1px) scale(1.01);
      box-shadow: 0 22px 45px rgba(37, 99, 235, 0.75);
      filter: saturate(1.1);
    }

    button:active:not(:disabled) {
      transform: translateY(0) scale(0.99);
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.7);
    }

    button:disabled {
      opacity: .45;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn-secondary {
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.35), rgba(148, 163, 184, 0.1));
      color: var(--text);
      margin-top: 10px;
      box-shadow: none;
      border: 1px solid rgba(148, 163, 184, 0.55);
    }

    .alert {
      padding: 13px 13px;
      border-radius: var(--radius-md);
      margin: 10px 0;
      font-size: 13px;
      font-weight: 800;
      line-height: 1.5;
    }

    .alert-error {
      background: radial-gradient(circle at top left, rgba(248, 113, 113, 0.18), transparent 60%);
      color: var(--error);
      border: 1px solid rgba(248, 113, 113, 0.5);
    }

    .alert-success {
      background: radial-gradient(circle at top left, rgba(52, 211, 153, 0.16), transparent 60%);
      color: var(--success);
      border: 1px solid rgba(52, 211, 153, 0.5);
    }

    .link {
      color: var(--primary);
      text-decoration: none;
      font-weight: 900;
    }

    .text-center {
      text-align: center;
    }

    .text-muted {
      color: var(--text-secondary);
      font-size: 13px;
    }

    .divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(148, 163, 184, 0.4), transparent);
      margin: 18px 0;
    }

    /* list / leaderboard */
    .list-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 13px;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.88), rgba(15, 23, 42, 0.7));
      border-radius: var(--radius-md);
      margin-bottom: 9px;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .list-item.active {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.3), rgba(59, 130, 246, 0.1));
      border: 1px solid rgba(59, 130, 246, 0.8);
      box-shadow: 0 14px 35px rgba(37, 99, 235, 0.55);
    }

    .rank-number {
      font-size: 17px;
      font-weight: 900;
      color: var(--text-secondary);
      min-width: 52px;
    }

    .rank-1 .rank-number {
      color: #D4AF37;
    }

    .rank-2 .rank-number {
      color: #C0C0C0;
    }

    .rank-3 .rank-number {
      color: #CD7F32;
    }

    .me-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      margin-left: 8px;
      border: 1px solid rgba(0, 122, 255, 0.25);
      background: rgba(0, 122, 255, 0.10);
      color: var(--primary);
    }

    .finish {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 900;
      color: var(--primary-light);
    }

    .finish .done {
      font-size: 16px;
      line-height: 1;
    }

    /* checkpoint */
    .checkpoint-card {
      background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.6), rgba(14, 116, 144, 0.85));
      color: white;
      padding: 20px 18px 22px;
      border-radius: var(--radius-lg);
      margin: 16px 0;
      text-align: center;
      box-shadow: 0 22px 60px rgba(30, 64, 175, 0.9);
    }

    .checkpoint-number {
      font-size: 42px;
      font-weight: 1000;
      margin-bottom: 4px;
    }

    .hint-box {
      background: linear-gradient(135deg, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.92));
      padding: 13px 13px 13px;
      border-radius: var(--radius-md);
      margin: 12px 0;
      border-left: 4px solid rgba(96, 165, 250, 0.9);
      line-height: 1.6;
      font-weight: 800;
      border-top: 1px solid rgba(148, 163, 184, 0.35);
      border-right: 1px solid rgba(30, 64, 175, 0.5);
      border-bottom: 1px solid rgba(15, 23, 42, 0.9);
    }

    /* trap */
    .trapCard {
      border: 1px solid rgba(239, 68, 68, .45);
      background:
        radial-gradient(130% 130% at 15% 0%, rgba(239, 68, 68, .4), transparent 60%),
        radial-gradient(140% 140% at 100% 15%, rgba(251, 191, 36, .25), transparent 60%),
        radial-gradient(120% 120% at 50% 110%, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.96));
      position: relative;
      overflow: hidden;
      box-shadow: 0 18px 55px rgba(127, 29, 29, 0.8);
    }

    .trapSkull {
      font-size: 44px;
    }

    .glitch {
      font-weight: 1000;
      letter-spacing: .10em;
      text-transform: uppercase;
      position: relative;
      display: inline-block;
    }

    .glitch::before,
    .glitch::after {
      content: attr(data-text);
      position: absolute;
      left: 0;
      top: 0;
      opacity: .65;
    }

    .glitch::before {
      transform: translate(2px, 0);
      color: rgba(255, 69, 58, .9);
    }

    .glitch::after {
      transform: translate(-2px, 0);
      color: rgba(10, 132, 255, .9);
    }

    .smallHint {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 10px;
      line-height: 1.6;
      font-weight: 800;
    }

    /* navbar */
    .navbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background:
        radial-gradient(circle at 10% -20%, rgba(59, 130, 246, 0.55), transparent 60%),
        rgba(15, 23, 42, 0.96);
      border-top: 1px solid rgba(148, 163, 184, 0.4);
      display: flex;
      padding: 8px 10px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      box-shadow: 0 -16px 40px rgba(15, 23, 42, 0.95);
      z-index: 1000;
      backdrop-filter: blur(22px);
    }

    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 6px;
      text-decoration: none;
      color: var(--text-secondary);
      font-size: 10px;
      font-weight: 900;
      border-radius: 12px;
      transition: all var(--transition-fast);
      user-select: none;
    }

    .nav-item.active {
      color: #E5F0FF;
      background: radial-gradient(circle at top, rgba(59, 130, 246, 0.7), rgba(37, 99, 235, 0.3));
      box-shadow: 0 12px 30px rgba(37, 99, 235, 0.9);
    }

    .nav-item:active {
      transform: scale(0.96) translateY(1px);
    }

    .nav-icon {
      font-size: 20px;
    }

    /* shake */
    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      20% {
        transform: translateX(-6px);
      }

      40% {
        transform: translateX(6px);
      }

      60% {
        transform: translateX(-4px);
      }

      80% {
        transform: translateX(4px);
      }
    }

    .shake {
      animation: shake 0.25s ease-in-out;
    }

    /* page transition animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .page-enter {
      animation: fadeIn 0.3s ease-out, slideInUp 0.3s ease-out;
    }

    /* loading spinner */
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(148, 163, 184, 0.3);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .spinner-large {
      width: 40px;
      height: 40px;
      border-width: 4px;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(8px);
    }

    .loading-content {
      text-align: center;
      color: var(--text);
    }

    .loading-content .spinner {
      margin-bottom: 12px;
    }

    /* toast notifications */
    @keyframes toastSlideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes toastSlideOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }

      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
      pointer-events: none;
    }

    .toast {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 14px 16px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      gap: 12px;
      pointer-events: auto;
      animation: toastSlideIn 0.3s ease-out;
      backdrop-filter: blur(18px);
    }

    .toast.hiding {
      animation: toastSlideOut 0.3s ease-out forwards;
    }

    .toast-success {
      border-left: 4px solid var(--success);
      background: radial-gradient(circle at top left, rgba(52, 211, 153, 0.2), var(--card));
    }

    .toast-error {
      border-left: 4px solid var(--error);
      background: radial-gradient(circle at top left, rgba(248, 113, 113, 0.2), var(--card));
    }

    .toast-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .toast-message {
      flex: 1;
      font-size: 14px;
      font-weight: 800;
      color: var(--text);
    }

    @media (max-width: 480px) {
      .container {
        padding: 14px 12px 110px;
      }

      .card {
        padding: 18px 14px 16px;
        border-radius: 16px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="app"></div>
  </div>

  <nav class="navbar">
    <a class="nav-item" href="#/">
      <div class="nav-icon">ğŸ </div>
      <div id="navHome">ãƒ›ãƒ¼ãƒ </div>
    </a>
    <a class="nav-item" href="#/scan">
      <div class="nav-icon">ğŸ“·</div>
      <div id="navScan">ã‚¹ã‚­ãƒ£ãƒ³</div>
    </a>
    <a class="nav-item" href="#/leaderboard">
      <div class="nav-icon">ğŸ†</div>
      <div id="navRank">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
    </a>
    <a class="nav-item" href="#/me">
      <div class="nav-icon">ğŸ‘¤</div>
      <div id="navMe">ãƒã‚¤ãƒšãƒ¼ã‚¸</div>
    </a>
  </nav>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ====== è¨­å®š ======
    const SUPABASE_URL = "https://ahynlwtcdrtkzykcccgb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoeW5sd3RjZHJ0a3p5a2NjY2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MTA0MDQsImV4cCI6MjA4Mjk4NjQwNH0.HttRXUS-Qy6VA0t4UE8MIC58tgncg-2bucYfLr14LSA";

    const MAX_CHECKPOINT = 5;
    let supportsRandomRoutes = true;

    // âœ… æ­£è§£QRï¼ˆæ¨æ¸¬å¯¾ç­–ï¼‰
    const CP_KEYS = {
      1: "f8K3",
      2: "Qm9A",
      3: "Z7pL",
      4: "Kx2R",
      5: "Bde7",
    };
    const TRAP_KEY = "TRAP";

    // =======================
    // i18nï¼ˆ5è¨€èªï¼‰
    // =======================
    const LANG_KEY = "brh_lang";
    let LANG = localStorage.getItem(LANG_KEY) || "en";

    const LANG_LABELS = {
      ja: "æ—¥æœ¬èª",
      en: "English",
      "zh-Hans": "ä¸­æ–‡(ç®€ä½“)",
      "zh-Hant": "ä¸­æ–‡(ç¹é«”)",
      es: "EspaÃ±ol",
    };

    // âœ… æ—¥æœ¬èªã‚’ã€Œæ­£æœ¬ã€
    const I18N_BASE = {
      APP_TITLE: "ğŸ BearsRockHunt",
      EVENT_BADGE: "ã‚¤ãƒ™ãƒ³ãƒˆ",
      LANG_BADGE: "è¨€èª",

      NAV_HOME: "ãƒ›ãƒ¼ãƒ ",
      NAV_SCAN: "ã‚¹ã‚­ãƒ£ãƒ³",
      NAV_RANK: "ãƒ©ãƒ³ã‚­ãƒ³ã‚°",
      NAV_ME: "ãƒã‚¤ãƒšãƒ¼ã‚¸",

      INTRO_TITLE: "ãƒ¼ãƒ èª¬æ˜",
      INTRO_DESC: "BearsRockå†…ã«éš ã•ã‚ŒãŸQRã‚³ãƒ¼ãƒ‰ã‚’æ¢ã—ã¦é€²ã‚€å®æ¢ã—ã‚²ãƒ¼ãƒ ã§ã™ã€‚<br>ãƒ’ãƒ³ãƒˆã‚’é ¼ã‚Šã«ã€é †ç•ªé€šã‚Šãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¦ãã ã•ã„ã€‚",
      INTRO_PRIZE_TITLE: "ğŸ æ™¯å“",
      INTRO_PRIZE_DESC: "å…¨ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’<b>ä¸€ç•ªæœ€åˆã«ã‚¯ãƒªã‚¢ã—ãŸï¼‘åã®ã¿</b>ã«è±ªè¯æ™¯å“ãŒã‚ã‚Šã¾ã™ï¼<br>ï¼ˆéƒ¨å±‹ç•ªå·ãŒå¿…è¦ã§ã™ï¼‰",
      INTRO_NOTE_1: "PINï¼ˆ4æ¡ï¼‰ã¯å†ãƒ­ã‚°ã‚¤ãƒ³ã«å¿…è¦",
      INTRO_NOTE_2: "æ¨æ¸¬URLã¯å…¨éƒ¨ãƒã‚ºãƒ¬",
      INTRO_NOTE_3: "QRã®ä¸‹ã«æ›¸ã„ã¦ã‚ã‚‹ã€Œåˆè¨€è‘‰ã€ãŒå¿…è¦",
      BTN_START: "â–¶ï¸ ã‚¹ã‚¿ãƒ¼ãƒˆ",

      HOME_DONE: "ã‚¯ãƒªã‚¢æ¸ˆã¿",
      HOME_LEFT: "æ®‹ã‚Š",
      HOME_DESC: "QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’é€²ã‚ã¾ã—ã‚‡ã†",
      BTN_SCAN: "ğŸ“· QRã‚’ã‚¹ã‚­ãƒ£ãƒ³",
      WELCOME: "ã‚ˆã†ã“ãã€{name}ã•ã‚“",
      HOME_HINT_NOTE: "ãƒ’ãƒ³ãƒˆã¯ãƒã‚¤ãƒšãƒ¼ã‚¸ã§ç¢ºèªã§ãã¾ã™ã€‚",

      LOGIN_TITLE: "ãƒ­ã‚°ã‚¤ãƒ³",
      LOGIN_CARD_TITLE: "ãŠã‹ãˆã‚Š",
      LOGIN_DESC: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ ã¨PINã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›",
      LABEL_NAME: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ ",
      LABEL_PIN: "PINï¼ˆ4æ¡ï¼‰",
      PH_NAME: "ä¾‹ï¼šBear",
      PH_PIN: "0000",
      BTN_LOGIN: "ãƒ­ã‚°ã‚¤ãƒ³",
      LOGIN_OK: "âœ“ ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ",
      LOGIN_FAIL: "ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼š{msg}",
      NEED_NAME: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦",
      NEED_PIN_4: "PINã¯4æ¡ã®æ•°å­—",
      LOGIN_TO_SIGNUP: "åˆã‚ã¦ãªã‚‰",
      LINK_SIGNUP: "æ–°è¦ç™»éŒ²",

      SIGNUP_TITLE: "æ–°è¦ç™»éŒ²",
      SIGNUP_CARD_TITLE: "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ",
      SIGNUP_DESC: "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ  / éƒ¨å±‹ç•ªå· / PINã‚’è¨­å®š",
      LABEL_ROOM: "éƒ¨å±‹ç•ªå·",
      PH_ROOM: "ä¾‹ï¼š203 / A-12",
      BTN_SIGNUP: "ç™»éŒ²ã—ã¦é–‹å§‹",
      SIGNUP_OK: "âœ“ ç™»éŒ²å®Œäº†",
      SIGNUP_FAIL: "ç™»éŒ²å¤±æ•—ï¼š{msg}",
      NEED_ROOM: "éƒ¨å±‹ç•ªå·ã‚’å…¥åŠ›ã—ã¦",
      SIGNUP_TO_LOGIN: "ç™»éŒ²æ¸ˆã¿ãªã‚‰",
      LINK_LOGIN: "ãƒ­ã‚°ã‚¤ãƒ³",

      CP_TITLE: "ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ",
      CP_LOCKED: "ğŸ”’ ã¾ã æ—©ã„ã€‚å…ˆã«CP{n}ã‚’ã‚¯ãƒªã‚¢ã—ã¦",
      BTN_BACK_HOME: "ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹",
      CP_VERIFY_TITLE: "åˆ°é”ç¢ºèª",
      CP_VERIFY_DESC: "QRã®ä¸‹ã«æ›¸ã„ã¦ã‚ã‚‹ã€Œåˆè¨€è‘‰ã€ã‚’å…¥åŠ›ã—ã¦ã­",
      LABEL_PASS: "åˆè¨€è‘‰",
      PH_PASS: "åˆè¨€è‘‰ã‚’å…¥åŠ›",
      BTN_CLAIM: "âœ“ åˆ°é”ã‚’ç¢ºèª",
      BTN_CHECKING: "ç¢ºèªä¸­...",
      PASS_REQUIRED: "åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦",
      PASS_WRONG: "åˆè¨€è‘‰ãŒé•ã†",
      ORDER_WRONG: "é †ç•ªãŒé•ã†ã€‚ã„ã¾ {cur} / {max}",
      FAIL_GENERIC: "å¤±æ•—ï¼š{msg}",
      UNLOCKED: "ã‚¯ãƒªã‚¢ï¼ æ¬¡ã®ãƒ’ãƒ³ãƒˆãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸ",
      HINT_TITLE: "ğŸ’¡ ãƒ’ãƒ³ãƒˆ {n}",

      TRAP_TITLE: "ğŸ˜ˆ ãƒã‚ºãƒ¬",
      TRAP_LINE_1: "ã“ã“ã«ã¯ä½•ã‚‚ãªã„ã€‚",
      TRAP_LINE_2: "æ¨æ¸¬ã—ã¦ã‚‚é€²æ—ã¯é€²ã¾ãªã„ã€‚",
      TRAP_LINE_3: "è¿‘é“æ¢ã™ã‚ˆã‚Šã€ãƒ’ãƒ³ãƒˆæ¢ã›ã€‚",
      TRAP_LINE_4: "ãã®æƒ…ç†±ã€æ­£è¦ãƒ«ãƒ¼ãƒˆã§é ¼ã‚€ã€‚",
      TRAP_NOTE_1: "âœ… æ­£è§£QRã¯ã€Œæ±ºã‚ãŸURLã ã‘ã€",
      TRAP_NOTE_2: "ğŸ”’ æ¨æ¸¬URLã¯å…¨éƒ¨ãƒã‚ºãƒ¬",

      CLEAR_TITLE: "ğŸ‰ ã‚¯ãƒªã‚¢ï¼",
      CLEAR_CONGRATS: "ãŠã‚ã§ã¨ã†ã€{name}ï¼",
      CLEAR_DESC: "å…¨ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚<br>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ç¢ºèªã—ã¦ã€ï¼‘ä½ãªã‚‰éƒ¨å±‹ã®å‰ã§å¾…ã£ã¦ã„ã¦ãã ã•ã„ï¼",
      CLEAR_PRIZE_TITLE: "ğŸ æ™¯å“",
      CLEAR_PRIZE_DESC: "é£Ÿå ‚ãƒã‚±ãƒƒãƒˆ",
      BTN_VIEW_ME: "ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚‹",
      BTN_HOME: "ãƒ›ãƒ¼ãƒ ã¸",

      SCAN_TITLE: "ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³",
      SCAN_CARD_TITLE: "QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹",
      SCAN_IOS_TIP: "iPhoneã®æ–¹ã¯ã€æ¨™æº–ã‚«ãƒ¡ãƒ©ã§QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„",
      SCAN_IOS_DESC: "QRã‚’èª­ã‚€ã¨Safariã§ãƒšãƒ¼ã‚¸ãŒé–‹ãã¾ã™ã€‚<br>é–‹ã„ç”»é¢ã§ã€Œåˆ°é”ã‚’ç¢ºèªã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚",
      SCAN_ANDROID_DESC: "ã“ã®ãƒšãƒ¼ã‚¸ã¯æ¡ˆå†…ã ã‘ã§ã™ï¼ˆQRã¯æ¨™æº–ã‚«ãƒ¡ãƒ©ã§OKï¼‰",

      ME_TITLE: "ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸",
      ME_PROGRESS: "é€²æ—",
      ME_RATE: "é”æˆç‡",
      ME_HINTS_TITLE: "è§£æ”¾æ¸ˆã¿ãƒ’ãƒ³ãƒˆ",
      ME_NO_HINTS: "ã¾ã ãƒ’ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",

      RANK_TITLE: "ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°",
      RANK_CARD_TITLE: "é€²æ—ãƒ©ãƒ³ã‚­ãƒ³ã‚°",
      RANK_DESC: "é€²æ—ãŒé«˜ã„é †ã€‚åŒç‡ã®å ´åˆã¯åˆ°é”ãŒæ—©ã„é †",
      LOADING: "èª­ã¿è¾¼ã¿ä¸­...",
      EMPTY: "ã¾ã èª°ã‚‚ã„ã¾ã›ã‚“",
      YOU_BADGE: "ã‚ãªãŸ",

      ERR_TITLE: "ã‚¨ãƒ©ãƒ¼ã§åœæ­¢ã—ã¾ã—ãŸ",
      ERR_HINT_1: "Supabaseã®ANON KEYã‚’å·®ã—æ›¿ãˆãŸï¼Ÿ",
      ERR_HINT_2: "RPCï¼ˆregister_player / claim_player / claim_checkpoint / get_leaderboardï¼‰ã¯å­˜åœ¨ã™ã‚‹ï¼Ÿ",
      ERR_HINT_3: "players / progress ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã‚ã‚‹ï¼Ÿ",

      HINT_1: "æ¯æœã€é´ãŒé›†ã¾ã‚‹å ´æ‰€ã®â€œä¸Šâ€ã‚’è¦‹ã‚",
      HINT_2: "ã„ã„åŒ‚ã„ãŒã™ã‚‹ã€‚ã•ã‚ã©ã“ã ã‚ã†",
      HINT_3: "ç”·ã©ã‚‚ãŒæ¯æœé›†ã¾ã‚‹å ´æ‰€",
      HINT_4: "ãã£ã›ãƒ¼ã€æ±šã­ãˆ",
      HINT_5: "ã‚¯ãƒªã‚¢ï¼",
    };

    const I18N = {
      en: {
        EVENT_BADGE: "Event",
        NAV_HOME: "Home",
        NAV_SCAN: "Scan",
        NAV_RANK: "Ranking",
        NAV_ME: "Me",
        INTRO_TITLE: "How to play",
        INTRO_DESC: "The first person to clear all checkpoints will receive a prize.<br>Follow the hints and clear them in order.",
        INTRO_PRIZE_TITLE: "ğŸ Prize",
        INTRO_PRIZE_DESC: "Clear all checkpoints to get a prize.<br>(Room number is required.)",
        INTRO_NOTE_1: "Your 4-digit PIN is needed to log in again",
        INTRO_NOTE_2: "Guessed URLs are all traps",
        INTRO_NOTE_3: "You need the passphrase written under the QR",
        BTN_START: "â–¶ï¸ Start",
        HOME_DONE: "Cleared",
        HOME_LEFT: "Left",
        HOME_DESC: "Scan QR codes to progress through checkpoints",
        BTN_SCAN: "ğŸ“· Scan QR",
        WELCOME: "Welcome, {name}",
        HOME_HINT_NOTE: "Hints are shown on your Me page.",
        LOGIN_TITLE: "Log in",
        LOGIN_CARD_TITLE: "Welcome back",
        LOGIN_DESC: "Enter your name and PIN",
        LABEL_NAME: "Name",
        LABEL_PIN: "PIN (4 digits)",
        PH_NAME: "e.g. Bear",
        PH_PIN: "0000",
        BTN_LOGIN: "Log in",
        LOGIN_OK: "âœ“ Logged in",
        LOGIN_FAIL: "Login failed: {msg}",
        NEED_NAME: "Please enter your name",
        NEED_PIN_4: "PIN must be 4 digits",
        LOGIN_TO_SIGNUP: "New here?",
        LINK_SIGNUP: "Sign up",
        SIGNUP_TITLE: "Sign up",
        SIGNUP_CARD_TITLE: "Create account",
        SIGNUP_DESC: "Set name / room / PIN",
        LABEL_ROOM: "Room",
        PH_ROOM: "e.g. 203 / A-12",
        BTN_SIGNUP: "Create & start",
        SIGNUP_OK: "âœ“ Registered",
        SIGNUP_FAIL: "Sign-up failed: {msg}",
        NEED_ROOM: "Please enter your room",
        SIGNUP_TO_LOGIN: "Already registered?",
        LINK_LOGIN: "Log in",
        CP_TITLE: "Checkpoint",
        CP_LOCKED: "ğŸ”’ Locked. Clear CP{n} first",
        BTN_BACK_HOME: "Back to Home",
        CP_VERIFY_TITLE: "Verify",
        CP_VERIFY_DESC: "Enter the passphrase under the QR",
        LABEL_PASS: "Passphrase",
        PH_PASS: "Enter passphrase",
        BTN_CLAIM: "âœ“ Verify",
        BTN_CHECKING: "Checking...",
        PASS_REQUIRED: "Enter the passphrase",
        PASS_WRONG: "Wrong passphrase",
        ORDER_WRONG: "Wrong order. Now {cur} / {max}",
        FAIL_GENERIC: "Failed: {msg}",
        UNLOCKED: "Cleared! Next hint unlocked",
        HINT_TITLE: "ğŸ’¡ Hint {n}",
        TRAP_TITLE: "ğŸ˜ˆ Trap",
        TRAP_NOTE_1: "âœ… Only the predefined QR URLs are valid",
        TRAP_NOTE_2: "ğŸ”’ Guessed URLs are all traps",
        CLEAR_TITLE: "ğŸ‰ Cleared!",
        CLEAR_CONGRATS: "Congrats, {name}!",
        CLEAR_DESC: "You cleared all checkpoints.<br>Your prize will be delivered to your room soon.",
        CLEAR_PRIZE_TITLE: "ğŸ Prize",
        CLEAR_PRIZE_DESC: "Cafeteria ticket",
        BTN_VIEW_ME: "View Me",
        BTN_HOME: "Home",
        SCAN_TITLE: "ğŸ“· Scan",
        SCAN_CARD_TITLE: "Scan a QR code",
        SCAN_IOS_TIP: "On iPhone, use the default Camera app to scan the QR",
        SCAN_IOS_DESC: "Scanning opens Safari.<br>On the opened page, tap â€œVerifyâ€.",
        SCAN_ANDROID_DESC: "This page is guidance only (default camera is OK).",
        ME_TITLE: "ğŸ‘¤ Me",
        ME_PROGRESS: "Progress",
        ME_RATE: "Completion",
        ME_HINTS_TITLE: "Unlocked hints",
        ME_NO_HINTS: "No hints yet.",
        RANK_TITLE: "ğŸ† Ranking",
        RANK_CARD_TITLE: "Progress ranking",
        RANK_DESC: "Higher progress first. If tied, earlier time wins",
        LOADING: "Loading...",
        EMPTY: "No players yet",
        YOU_BADGE: "You",
        ERR_TITLE: "Stopped by error",
        HINT_1: "Look above the place where shoes gather every morning.",
        HINT_2: "Smells goodâ€¦ where could it be?",
        HINT_3: "The place where the guys gather every morning.",
        HINT_4: "It stinks. Itâ€™s filthy.",
        HINT_5: "Cleared!",
      },
      "zh-Hans": {
        EVENT_BADGE: "æ´»åŠ¨",
        NAV_HOME: "é¦–é¡µ",
        NAV_SCAN: "æ‰«ç ",
        NAV_RANK: "æ’å",
        NAV_ME: "æˆ‘çš„",
        INTRO_TITLE: "ç©æ³•è¯´æ˜",
        INTRO_DESC: "åœ¨ BearsRock å†…å¯»æ‰¾éšè—çš„äºŒç»´ç å¹¶æ¨è¿›å…³å¡ã€‚<br>è¯·æŒ‰é¡ºåºæ ¹æ®æç¤ºé€šå…³ã€‚",
        INTRO_PRIZE_TITLE: "ğŸ å¥–å“",
        INTRO_PRIZE_DESC: "é€šå…³æ‰€æœ‰å…³å¡å³å¯è·å¾—å¥–å“ã€‚<br>ï¼ˆéœ€è¦æˆ¿é—´å·ï¼‰",
        INTRO_NOTE_1: "4ä½ PIN ç”¨äºå†æ¬¡ç™»å½•",
        INTRO_NOTE_2: "çŒœæµ‹é“¾æ¥éƒ½ä¼šåˆ¤å®šä¸ºé™·é˜±",
        INTRO_NOTE_3: "éœ€è¦è¾“å…¥äºŒç»´ç ä¸‹æ–¹çš„â€œå£ä»¤â€",
        BTN_START: "â–¶ï¸ å¼€å§‹",
        HOME_DONE: "å·²é€šå…³",
        HOME_LEFT: "å‰©ä½™",
        HOME_DESC: "æ‰«æäºŒç»´ç æ¥æ¨è¿›å…³å¡",
        BTN_SCAN: "ğŸ“· æ‰«æäºŒç»´ç ",
        WELCOME: "æ¬¢è¿ï¼Œ{name}",
        HOME_HINT_NOTE: "æç¤ºåœ¨â€œæˆ‘çš„â€é¡µé¢æŸ¥çœ‹ã€‚",
        LOGIN_TITLE: "ç™»å½•",
        LOGIN_CARD_TITLE: "æ¬¢è¿å›æ¥",
        LOGIN_DESC: "è¯·è¾“å…¥åå­—å’Œ PIN",
        LABEL_NAME: "åå­—",
        LABEL_PIN: "PINï¼ˆ4ä½ï¼‰",
        PH_NAME: "ä¾‹å¦‚ï¼šBear",
        PH_PIN: "0000",
        BTN_LOGIN: "ç™»å½•",
        NEED_NAME: "è¯·è¾“å…¥åå­—",
        NEED_PIN_4: "PIN å¿…é¡»ä¸º4ä½æ•°å­—",
        LOGIN_TO_SIGNUP: "ç¬¬ä¸€æ¬¡ï¼Ÿ",
        LINK_SIGNUP: "æ³¨å†Œ",
        SIGNUP_TITLE: "æ³¨å†Œ",
        SIGNUP_CARD_TITLE: "åˆ›å»ºè´¦å·",
        SIGNUP_DESC: "è®¾ç½® åå­— / æˆ¿é—´å· / PIN",
        LABEL_ROOM: "æˆ¿é—´å·",
        PH_ROOM: "ä¾‹å¦‚ï¼š203 / A-12",
        BTN_SIGNUP: "æ³¨å†Œå¹¶å¼€å§‹",
        NEED_ROOM: "è¯·è¾“å…¥æˆ¿é—´å·",
        SIGNUP_TO_LOGIN: "å·²æ³¨å†Œï¼Ÿ",
        LINK_LOGIN: "ç™»å½•",
        CP_TITLE: "å…³å¡",
        CP_LOCKED: "ğŸ”’ å·²é”å®šï¼šè¯·å…ˆé€šå…³ CP{n}",
        BTN_BACK_HOME: "è¿”å›é¦–é¡µ",
        CP_VERIFY_TITLE: "åˆ°è¾¾ç¡®è®¤",
        CP_VERIFY_DESC: "è¯·è¾“å…¥äºŒç»´ç ä¸‹æ–¹çš„å£ä»¤",
        LABEL_PASS: "å£ä»¤",
        PH_PASS: "è¾“å…¥å£ä»¤",
        BTN_CLAIM: "âœ“ ç¡®è®¤åˆ°è¾¾",
        BTN_CHECKING: "ç¡®è®¤ä¸­...",
        PASS_REQUIRED: "è¯·è¾“å…¥å£ä»¤",
        PASS_WRONG: "å£ä»¤ä¸æ­£ç¡®",
        ORDER_WRONG: "é¡ºåºä¸å¯¹ã€‚å½“å‰ {cur} / {max}",
        UNLOCKED: "é€šå…³ï¼å·²è§£é”ä¸‹ä¸€æ¡æç¤º",
        HINT_TITLE: "ğŸ’¡ æç¤º {n}",
        TRAP_TITLE: "ğŸ˜ˆ é™·é˜±",
        TRAP_NOTE_1: "âœ… åªæœ‰é¢„è®¾çš„äºŒç»´ç é“¾æ¥æœ‰æ•ˆ",
        TRAP_NOTE_2: "ğŸ”’ çŒœæµ‹é“¾æ¥éƒ½ä¼šåˆ¤å®šä¸ºé™·é˜±",
        CLEAR_TITLE: "ğŸ‰ é€šå…³ï¼",
        CLEAR_CONGRATS: "æ­å–œï¼Œ{name}ï¼",
        CLEAR_DESC: "ä½ å·²é€šå…³æ‰€æœ‰å…³å¡ã€‚<br>å¥–å“ç¨åä¼šæ”¾åœ¨ä½ çš„æˆ¿é—¨å‰ã€‚",
        CLEAR_PRIZE_TITLE: "ğŸ å¥–å“",
        CLEAR_PRIZE_DESC: "é£Ÿå ‚åˆ¸",
        BTN_VIEW_ME: "æŸ¥çœ‹æˆ‘çš„",
        BTN_HOME: "è¿”å›é¦–é¡µ",
        SCAN_TITLE: "ğŸ“· æ‰«ç ",
        SCAN_CARD_TITLE: "æ‰«æäºŒç»´ç ",
        SCAN_IOS_TIP: "iPhone è¯·ç”¨ç³»ç»Ÿç›¸æœºæ‰«æäºŒç»´ç ",
        SCAN_IOS_DESC: "æ‰«æåä¼šæ‰“å¼€ Safariã€‚<br>åœ¨æ‰“å¼€çš„é¡µé¢ç‚¹å‡»â€œç¡®è®¤åˆ°è¾¾â€ã€‚",
        SCAN_ANDROID_DESC: "æ­¤é¡µä»…ä¸ºè¯´æ˜ï¼ˆç”¨ç³»ç»Ÿç›¸æœºå³å¯ï¼‰ã€‚",
        ME_TITLE: "ğŸ‘¤ æˆ‘çš„",
        ME_PROGRESS: "è¿›åº¦",
        ME_RATE: "å®Œæˆç‡",
        ME_HINTS_TITLE: "å·²è§£é”æç¤º",
        ME_NO_HINTS: "æš‚æ— æç¤ºã€‚",
        RANK_TITLE: "ğŸ† æ’å",
        RANK_CARD_TITLE: "è¿›åº¦æ’å",
        RANK_DESC: "è¿›åº¦é«˜è€…ä¼˜å…ˆï¼›è‹¥ç›¸åŒï¼Œå…ˆåˆ°è€…ä¼˜å…ˆ",
        LOADING: "åŠ è½½ä¸­...",
        EMPTY: "æš‚æ— ç©å®¶",
        YOU_BADGE: "ä½ ",
        HINT_1: "çœ‹çœ‹æ¯å¤©æ—©ä¸Šé‹å­èšé›†çš„åœ°æ–¹ä¸Šæ–¹ã€‚",
        HINT_2: "é—»èµ·æ¥å¾ˆé¦™â€¦â€¦ä¼šåœ¨å“ªé‡Œå‘¢ï¼Ÿ",
        HINT_3: "ç”·ç”Ÿä»¬æ¯å¤©æ—©ä¸Šèšåœ¨ä¸€èµ·çš„åœ°æ–¹ã€‚",
        HINT_4: "åˆè‡­åˆè„ã€‚",
        HINT_5: "é€šå…³ï¼",
      },
      "zh-Hant": {
        EVENT_BADGE: "æ´»å‹•",
        NAV_HOME: "é¦–é ",
        NAV_SCAN: "æƒæ",
        NAV_RANK: "æ’è¡Œæ¦œ",
        NAV_ME: "æˆ‘çš„",
        INTRO_TITLE: "éŠæˆ²èªªæ˜",
        INTRO_DESC: "åœ¨ BearsRock å…§å°‹æ‰¾éš±è—çš„ QR Code ä¸¦æ¨é€²é—œå¡ã€‚<br>è«‹ä¾æç¤ºæŒ‰é †åºé€šé—œã€‚",
        INTRO_PRIZE_TITLE: "ğŸ çå“",
        INTRO_PRIZE_DESC: "é€šé—œæ‰€æœ‰é—œå¡å³å¯ç²å¾—çå“ã€‚<br>ï¼ˆéœ€è¦æˆ¿è™Ÿï¼‰",
        INTRO_NOTE_1: "4ä½ PIN ç”¨æ–¼å†æ¬¡ç™»å…¥",
        INTRO_NOTE_2: "çŒœæ¸¬é€£çµéƒ½æœƒåˆ¤å®šç‚ºé™·é˜±",
        INTRO_NOTE_3: "éœ€è¦è¼¸å…¥ QR ä¸‹æ–¹çš„ã€Œåˆè¨€è‘‰ã€",
        BTN_START: "â–¶ï¸ é–‹å§‹",
        HOME_DONE: "å·²å®Œæˆ",
        HOME_LEFT: "å‰©é¤˜",
        HOME_DESC: "æƒæ QR Code æ¨é€²é—œå¡",
        BTN_SCAN: "ğŸ“· æƒæ QR",
        WELCOME: "æ­¡è¿ï¼Œ{name}",
        HOME_HINT_NOTE: "æç¤ºåœ¨ã€Œæˆ‘çš„ã€é é¢æŸ¥çœ‹ã€‚",
        LOGIN_TITLE: "ç™»å…¥",
        LOGIN_CARD_TITLE: "æ­¡è¿å›ä¾†",
        LOGIN_DESC: "è«‹è¼¸å…¥åå­—èˆ‡ PIN",
        LABEL_NAME: "åå­—",
        LABEL_PIN: "PINï¼ˆ4ä½ï¼‰",
        PH_NAME: "ä¾‹å¦‚ï¼šBear",
        PH_PIN: "0000",
        BTN_LOGIN: "ç™»å…¥",
        NEED_NAME: "è«‹è¼¸å…¥åå­—",
        NEED_PIN_4: "PIN å¿…é ˆç‚º4ä½æ•¸å­—",
        LOGIN_TO_SIGNUP: "ç¬¬ä¸€æ¬¡ï¼Ÿ",
        LINK_SIGNUP: "è¨»å†Š",
        SIGNUP_TITLE: "è¨»å†Š",
        SIGNUP_CARD_TITLE: "å»ºç«‹å¸³è™Ÿ",
        SIGNUP_DESC: "è¨­å®š åå­— / æˆ¿è™Ÿ / PIN",
        LABEL_ROOM: "æˆ¿è™Ÿ",
        PH_ROOM: "ä¾‹å¦‚ï¼š203 / A-12",
        BTN_SIGNUP: "è¨»å†Šä¸¦é–‹å§‹",
        NEED_ROOM: "è«‹è¼¸å…¥æˆ¿è™Ÿ",
        SIGNUP_TO_LOGIN: "å·²è¨»å†Šï¼Ÿ",
        LINK_LOGIN: "ç™»å…¥",
        CP_TITLE: "é—œå¡",
        CP_LOCKED: "ğŸ”’ å·²é–å®šï¼šè«‹å…ˆå®Œæˆ CP{n}",
        BTN_BACK_HOME: "å›åˆ°é¦–é ",
        CP_VERIFY_TITLE: "åˆ°é”ç¢ºèª",
        CP_VERIFY_DESC: "è«‹è¼¸å…¥ QR ä¸‹æ–¹çš„åˆè¨€è‘‰",
        LABEL_PASS: "åˆè¨€è‘‰",
        PH_PASS: "è¼¸å…¥åˆè¨€è‘‰",
        BTN_CLAIM: "âœ“ ç¢ºèªåˆ°é”",
        BTN_CHECKING: "ç¢ºèªä¸­...",
        PASS_REQUIRED: "è«‹è¼¸å…¥åˆè¨€è‘‰",
        PASS_WRONG: "åˆè¨€è‘‰ä¸æ­£ç¢º",
        ORDER_WRONG: "é †åºä¸å°ã€‚ç›®å‰ {cur} / {max}",
        UNLOCKED: "å®Œæˆï¼å·²è§£é–ä¸‹ä¸€æ¢æç¤º",
        HINT_TITLE: "ğŸ’¡ æç¤º {n}",
        TRAP_TITLE: "ğŸ˜ˆ é™·é˜±",
        TRAP_NOTE_1: "âœ… åªæœ‰é è¨­çš„ QR é€£çµæœ‰æ•ˆ",
        TRAP_NOTE_2: "ğŸ”’ çŒœæ¸¬é€£çµéƒ½æœƒåˆ¤å®šç‚ºé™·é˜±",
        CLEAR_TITLE: "ğŸ‰ é€šé—œï¼",
        CLEAR_CONGRATS: "æ­å–œï¼Œ{name}ï¼",
        CLEAR_DESC: "ä½ å·²é€šé—œæ‰€æœ‰é—œå¡ã€‚<br>çå“ç¨å¾Œæœƒæ”¾åœ¨ä½ çš„æˆ¿é–€å‰ã€‚",
        CLEAR_PRIZE_TITLE: "ğŸ çå“",
        CLEAR_PRIZE_DESC: "é£Ÿå ‚åˆ¸",
        BTN_VIEW_ME: "æŸ¥çœ‹æˆ‘çš„",
        BTN_HOME: "å›åˆ°é¦–é ",
        SCAN_TITLE: "ğŸ“· æƒæ",
        SCAN_CARD_TITLE: "æƒæ QR Code",
        SCAN_IOS_TIP: "iPhone è«‹ç”¨ç³»çµ±ç›¸æ©Ÿæƒæ QR Code",
        SCAN_IOS_DESC: "æƒæå¾Œæœƒé–‹å•Ÿ Safariã€‚<br>åœ¨é–‹å•Ÿçš„é é¢æŒ‰ã€Œåˆ°é”ç¢ºèªã€ã€‚",
        SCAN_ANDROID_DESC: "æ­¤é åƒ…ç‚ºèªªæ˜ï¼ˆç”¨ç³»çµ±ç›¸æ©Ÿå³å¯ï¼‰ã€‚",
        ME_TITLE: "ğŸ‘¤ æˆ‘çš„",
        ME_PROGRESS: "é€²åº¦",
        ME_RATE: "å®Œæˆç‡",
        ME_HINTS_TITLE: "å·²è§£é–æç¤º",
        ME_NO_HINTS: "ç›®å‰æ²’æœ‰æç¤ºã€‚",
        RANK_TITLE: "ğŸ† æ’è¡Œæ¦œ",
        RANK_CARD_TITLE: "é€²åº¦æ’è¡Œæ¦œ",
        RANK_DESC: "é€²åº¦é«˜è€…å„ªå…ˆï¼›åŒåˆ†å‰‡å…ˆåˆ°è€…å„ªå…ˆ",
        LOADING: "è¼‰å…¥ä¸­...",
        EMPTY: "ç›®å‰æ²’æœ‰äºº",
        YOU_BADGE: "ä½ ",
        HINT_1: "çœ‹çœ‹æ¯å¤©æ—©ä¸Šé‹å­èšé›†çš„åœ°æ–¹ä¸Šæ–¹ã€‚",
        HINT_2: "èèµ·ä¾†å¾ˆé¦™â€¦â€¦æœƒåœ¨å“ªè£¡å‘¢ï¼Ÿ",
        HINT_3: "ç”·ç”Ÿå€‘æ¯å¤©æ—©ä¸Šèšåœ¨ä¸€èµ·çš„åœ°æ–¹ã€‚",
        HINT_4: "åˆè‡­åˆé«’ã€‚",
        HINT_5: "é€šé—œï¼",
      },
      es: {
        EVENT_BADGE: "Evento",
        NAV_HOME: "Inicio",
        NAV_SCAN: "Escanear",
        NAV_RANK: "Ranking",
        NAV_ME: "Mi perfil",
        INTRO_TITLE: "CÃ³mo jugar",
        INTRO_DESC: "Busca los cÃ³digos QR escondidos en BearsRock y avanza por los puntos.<br>Sigue las pistas y completa en orden.",
        INTRO_PRIZE_TITLE: "ğŸ Premio",
        INTRO_PRIZE_DESC: "Si completas todos los puntos, recibes un premio.<br>(Se necesita nÃºmero de habitaciÃ³n.)",
        INTRO_NOTE_1: "El PIN de 4 dÃ­gitos sirve para volver a iniciar sesiÃ³n",
        INTRO_NOTE_2: "Las URLs adivinadas siempre son trampa",
        INTRO_NOTE_3: "Necesitas la contraseÃ±a escrita debajo del QR",
        BTN_START: "â–¶ï¸ Empezar",
        HOME_DONE: "Completados",
        HOME_LEFT: "Restantes",
        HOME_DESC: "Escanea los QR para avanzar por los puntos",
        BTN_SCAN: "ğŸ“· Escanear QR",
        WELCOME: "Bienvenido, {name}",
        HOME_HINT_NOTE: "Las pistas estÃ¡n en tu perfil.",
        LOGIN_TITLE: "Iniciar sesiÃ³n",
        LOGIN_CARD_TITLE: "Bienvenido de vuelta",
        LOGIN_DESC: "Escribe tu nombre y PIN",
        LABEL_NAME: "Nombre",
        LABEL_PIN: "PIN (4 dÃ­gitos)",
        PH_NAME: "Ej.: Bear",
        PH_PIN: "0000",
        BTN_LOGIN: "Entrar",
        NEED_NAME: "Escribe tu nombre",
        NEED_PIN_4: "El PIN debe tener 4 dÃ­gitos",
        LOGIN_TO_SIGNUP: "Â¿Primera vez?",
        LINK_SIGNUP: "Registrarse",
        SIGNUP_TITLE: "Registro",
        SIGNUP_CARD_TITLE: "Crear cuenta",
        SIGNUP_DESC: "Nombre / HabitaciÃ³n / PIN",
        LABEL_ROOM: "HabitaciÃ³n",
        PH_ROOM: "Ej.: 203 / A-12",
        BTN_SIGNUP: "Crear y empezar",
        NEED_ROOM: "Escribe tu habitaciÃ³n",
        SIGNUP_TO_LOGIN: "Â¿Ya registrado?",
        LINK_LOGIN: "Iniciar sesiÃ³n",
        CP_TITLE: "Checkpoint",
        CP_LOCKED: "ğŸ”’ Bloqueado. Completa CP{n} primero",
        BTN_BACK_HOME: "Volver al inicio",
        CP_VERIFY_TITLE: "Verificar",
        CP_VERIFY_DESC: "Introduce la contraseÃ±a debajo del QR",
        LABEL_PASS: "ContraseÃ±a",
        PH_PASS: "Escribe la contraseÃ±a",
        BTN_CLAIM: "âœ“ Verificar",
        BTN_CHECKING: "Verificando...",
        PASS_REQUIRED: "Escribe la contraseÃ±a",
        PASS_WRONG: "ContraseÃ±a incorrecta",
        ORDER_WRONG: "Orden incorrecto. Ahora {cur} / {max}",
        UNLOCKED: "Â¡Completado! Nueva pista desbloqueada",
        HINT_TITLE: "ğŸ’¡ Pista {n}",
        TRAP_TITLE: "ğŸ˜ˆ Trampa",
        TRAP_NOTE_1: "âœ… Solo valen las URLs de QR definidas",
        TRAP_NOTE_2: "ğŸ”’ Las URLs adivinadas son trampa",
        CLEAR_TITLE: "ğŸ‰ Â¡Completado!",
        CLEAR_CONGRATS: "Â¡Felicidades, {name}!",
        CLEAR_DESC: "Has completado todos los checkpoints.<br>El premio llegarÃ¡ a tu puerta pronto.",
        CLEAR_PRIZE_TITLE: "ğŸ Premio",
        CLEAR_PRIZE_DESC: "Ticket del comedor",
        BTN_VIEW_ME: "Ver perfil",
        BTN_HOME: "Inicio",
        SCAN_TITLE: "ğŸ“· Escanear",
        SCAN_CARD_TITLE: "Escanear un QR",
        SCAN_IOS_TIP: "En iPhone, usa la app CÃ¡mara para escanear el QR",
        SCAN_IOS_DESC: "Se abrirÃ¡ Safari.<br>En la pÃ¡gina, toca â€œVerificarâ€.",
        SCAN_ANDROID_DESC: "Esta pÃ¡gina es solo guÃ­a (la cÃ¡mara del mÃ³vil sirve).",
        ME_TITLE: "ğŸ‘¤ Mi perfil",
        ME_PROGRESS: "Progreso",
        ME_RATE: "Completado",
        ME_HINTS_TITLE: "Pistas desbloqueadas",
        ME_NO_HINTS: "AÃºn no hay pistas.",
        RANK_TITLE: "ğŸ† Ranking",
        RANK_CARD_TITLE: "Ranking de progreso",
        RANK_DESC: "MÃ¡s progreso primero; si empatan, gana quien llegÃ³ antes",
        LOADING: "Cargando...",
        EMPTY: "AÃºn no hay jugadores",
        YOU_BADGE: "TÃº",
        HINT_1: "Mira arriba del lugar donde se juntan los zapatos cada maÃ±ana.",
        HINT_2: "Huele bienâ€¦ Â¿dÃ³nde serÃ¡?",
        HINT_3: "El lugar donde se juntan los chicos cada maÃ±ana.",
        HINT_4: "Huele fatal. EstÃ¡ asqueroso.",
        HINT_5: "Â¡Completado!",
      }
    };

    function t(key, vars = {}) {
      const text = (LANG !== "ja" ? I18N[LANG]?.[key] : null) ?? I18N_BASE[key] ?? key;
      return String(text).replace(/\{(\w+)\}/g, (_, k) => (vars[k] ?? `{${k}}`));
    }

    function setLang(lang) {
      if (!LANG_LABELS[lang]) return;
      LANG = lang;
      localStorage.setItem(LANG_KEY, lang);
      document.documentElement.lang = (lang === "zh-Hans" || lang === "zh-Hant") ? "zh" : lang;
      applyStaticI18n();
      handleRoute();
    }
    window.__setLang = setLang;

    function langSegmentHtml() {
      const short = { ja: "JA", en: "EN", "zh-Hans": "ç®€", "zh-Hant": "ç¹", es: "ES" };
      const order = ["ja", "en", "zh-Hans", "zh-Hant", "es"];
      return `
        <div class="lang-seg" role="tablist" aria-label="Language">
          ${order.map(k => `
            <button type="button"
              class="${k === LANG ? "active" : ""}"
              onclick="window.__setLang('${k}')"
              aria-pressed="${k === LANG}"
              title="${LANG_LABELS[k] ?? k}"
            >${short[k] ?? k}</button>
          `).join("")}
        </div>
      `;
    }

    function headerHtml(titleText, rightHtml = "", showLang = true) {
      return `
        <div class="header">
          <h1 class="truncate">${titleText}</h1>
          <div class="badge-right">
            ${rightHtml}
            ${showLang ? langSegmentHtml() : ""}
          </div>
        </div>
      `;
    }

    function applyStaticI18n() {
      document.title = t("APP_TITLE");
      document.getElementById("navHome").textContent = t("NAV_HOME");
      document.getElementById("navScan").textContent = t("NAV_SCAN");
      document.getElementById("navRank").textContent = t("NAV_RANK");
      document.getElementById("navMe").textContent = t("NAV_ME");
      document.documentElement.lang = (LANG === "zh-Hans" || LANG === "zh-Hant") ? "zh" : LANG;
    }

    // ==================
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    const app = document.getElementById("app");

    // ====== utils ======
    const el = (html) => {
      const d = document.createElement("div");
      d.innerHTML = html.trim();
      return d.firstChild;
    };
    const progressPercent = (current, max = MAX_CHECKPOINT) => {
      const v = Math.max(0, Math.min(current, max));
      return Math.round((v / max) * 100);
    };
    const isIOS = () =>
      /iPad|iPhone|iPod/.test(navigator.userAgent) ||
      (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);

    // ====== UI utilities ======
    let loadingOverlay = null;
    function showLoading(message = "") {
      if (loadingOverlay) return;
      loadingOverlay = el(`
        <div class="loading-overlay">
          <div class="loading-content">
            <div class="spinner spinner-large"></div>
            ${message ? `<div style="margin-top:12px;font-weight:800;color:var(--text);">${message}</div>` : ""}
          </div>
        </div>
      `);
      document.body.appendChild(loadingOverlay);
    }
    function hideLoading() {
      if (loadingOverlay) {
        loadingOverlay.remove();
        loadingOverlay = null;
      }
    }

    let toastContainer = null;
    function initToastContainer() {
      if (!toastContainer) {
        toastContainer = el(`<div class="toast-container"></div>`);
        document.body.appendChild(toastContainer);
      }
      return toastContainer;
    }
    function showToast(message, type = "success", duration = 3000) {
      const container = initToastContainer();
      const icon = type === "success" ? "âœ“" : "âœ•";
      const toast = el(`
        <div class="toast toast-${type}">
          <div class="toast-icon">${icon}</div>
          <div class="toast-message">${message}</div>
        </div>
      `);
      container.appendChild(toast);
      setTimeout(() => {
        toast.classList.add("hiding");
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    function animatePageEnter(element) {
      if (!element) return;
      element.style.opacity = "0";
      element.style.transform = "translateY(20px)";
      requestAnimationFrame(() => {
        element.classList.add("page-enter");
        element.style.opacity = "";
        element.style.transform = "";
      });
    }

    async function retryOperation(operation, maxRetries = 3, delay = 1000) {
      for (let i = 0; i < maxRetries; i++) {
        try {
          return await operation();
        } catch (error) {
          if (i === maxRetries - 1) throw error;
          await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
        }
      }
    }

    function setNavActive() {
      const links = document.querySelectorAll(".nav-item");
      links.forEach(a => a.classList.remove("active"));
      const h = location.hash || "#/";
      const target =
        h.startsWith("#/c/") ? "#/" :
          (["#/scan", "#/leaderboard", "#/me", "#/"].includes(h) ? h : "#/login");
      links.forEach(a => {
        if (a.getAttribute("href") === target) a.classList.add("active");
      });
    }

    // ====== router ======
    function getRoute() {
      const h = location.hash || "";

      if (h === "" || h === "#") return { type: "intro" };
      if (h === "#/intro") return { type: "intro" };
      if (h === "#/") return { type: "home" };

      const m = h.match(/^#\/c\/(\d+)-([A-Za-z0-9]+)$/);
      if (m) return { type: "cp", n: parseInt(m[1], 10), key: m[2] };

      if (h === "#/login") return { type: "login" };
      if (h === "#/signup") return { type: "signup" };
      if (h === "#/scan") return { type: "scan" };
      if (h === "#/leaderboard") return { type: "leaderboard" };
      if (h === "#/me") return { type: "me" };
      if (h === "#/clear") return { type: "clear" };

      return { type: "unknown" };
    }

    // ====== auth / db ======
    async function ensureAnonLogin() {
      const { data: { session } } = await sb.auth.getSession();
      if (session) return session.user;
      const { data, error } = await sb.auth.signInAnonymously();
      if (error) throw error;
      return data.session.user;
    }
    async function getMe() {
      const { data: { user } } = await sb.auth.getUser();
      return user;
    }
    async function getNickname(user_id) {
      const { data, error } = await sb.from("players").select("nickname").eq("user_id", user_id).maybeSingle();
      if (error) throw error;
      return data?.nickname ?? null;
    }
    // ====== utils ======
    // Deterministic Shuffle (seeded by user ID)
    function mulberry32(a) {
      return function () {
        var t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      }
    }
    function buildSequentialRoute(max = MAX_CHECKPOINT) {
      return Array.from({ length: max }, (_, i) => i + 1);
    }

    function getUserRoute(userId, useRandom = true) {
      if (!useRandom || !userId) return buildSequentialRoute();
      // Create seed from UUID (simple sum of char codes)
      let seed = 0;
      for (let i = 0; i < userId.length; i++) seed += userId.charCodeAt(i);
      const rng = mulberry32(seed);

      const arr = buildSequentialRoute();
      // Fisher-Yates Shuffle
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function normalizeProgress(data, hasClearedCheckpoints) {
      const base = data ?? { checkpoint: 0, updated_at: null };
      const checkpoint = base.checkpoint ?? 0;
      if (hasClearedCheckpoints) {
        const cleared = Array.isArray(base.cleared_checkpoints) ? base.cleared_checkpoints : [];
        return { ...base, checkpoint, cleared_checkpoints: cleared };
      }
      return {
        ...base,
        checkpoint,
        cleared_checkpoints: buildSequentialRoute(checkpoint)
      };
    }

    async function getProgress(user_id) {
      // Prefer new schema with cleared_checkpoints.
      try {
        const { data, error } = await sb
          .from("progress")
          .select("checkpoint, updated_at, cleared_checkpoints")
          .eq("user_id", user_id)
          .maybeSingle();
        if (error) throw error;
        supportsRandomRoutes = true;
        return normalizeProgress(data, true);
      } catch (error) {
        const message = error?.message ?? String(error);
        if (!message.includes("cleared_checkpoints")) {
          throw error;
        }
        supportsRandomRoutes = false;
        const { data, error: fallbackError } = await sb
          .from("progress")
          .select("checkpoint, updated_at")
          .eq("user_id", user_id)
          .maybeSingle();
        if (fallbackError) throw fallbackError;
        return normalizeProgress(data, false);
      }
    }

    async function advanceWithPassphrase(user_id, targetCheckpoint, passphrase) {
      const pass = (passphrase ?? "").trim();
      if (!pass) return { ok: false, reason: "no_passphrase" };

      const { data, error } = await sb.rpc("claim_checkpoint", { cp: targetCheckpoint, pass });
      if (error) {
        const m = error.message || String(error);
        if (m.includes("invalid passphrase")) return { ok: false, reason: "invalid_passphrase" };
        if (m.includes("wrong order")) {
          const cur = await getProgress(user_id);
          return { ok: false, reason: "wrong_order", current: cur.checkpoint };
        }
        return { ok: false, reason: "other", message: m };
      }
      return { ok: true, current: data ?? targetCheckpoint };
    }

    function hintText(n) { return t(`HINT_${n}`); }

    // ====== render ======
    function renderIntro() {
      app.innerHTML = "";
      app.appendChild(el(`
        <div>
          ${headerHtml(t("APP_TITLE"), `<div class="badge">${t("EVENT_BADGE")}</div>`, true)}
          <div class="card">
            <div class="card-title">${t("INTRO_TITLE")}</div>
            <p class="card-subtitle">${t("INTRO_DESC")}</p>

            <div class="hint-box">
              <strong>${t("INTRO_PRIZE_TITLE")}</strong><br>
              ${t("INTRO_PRIZE_DESC")}
            </div>

            <div class="divider"></div>

            <p class="text-muted" style="font-size:13px;line-height:1.6;">
              ãƒ»${t("INTRO_NOTE_1")}<br>
              ãƒ»${t("INTRO_NOTE_2")}<br>
              ãƒ»${t("INTRO_NOTE_3")}
            </p>

            <button type="button" style="margin-top:14px;" onclick="location.hash='#/login'">${t("BTN_START")}</button>
          </div>
        </div>
      `));
    }

    function renderHome(nickname, prog, myRoute) {
      app.innerHTML = "";
      const currentCount = prog.cleared_checkpoints?.length ?? 0;
      const target = myRoute ? myRoute.find(cp => !(prog.cleared_checkpoints || []).includes(cp)) : (currentCount + 1);

      app.appendChild(el(`
        <div>
          ${headerHtml(t("APP_TITLE"), "", true)}

          <div class="card">
            <div class="stats">
              <div class="stat-item">
                <div class="stat-value">${currentCount}</div>
                <div class="stat-label">${t("HOME_DONE")}</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${Math.max(0, MAX_CHECKPOINT - currentCount)}</div>
                <div class="stat-label">${t("HOME_LEFT")}</div>
              </div>
            </div>

            <div class="progress-container">
              <div class="progress-bar" style="width:${progressPercent(currentCount)}%"></div>
            </div>

            <p class="card-subtitle">${t("HOME_DESC")}</p>
            <button type="button" onclick="location.hash='#/scan'">${t("BTN_SCAN")}</button>
          </div>

          <div class="card">
            <div class="card-title">${t("WELCOME", { name: nickname })}</div>
            <div class="hint-box" style="margin-top:10px;">
               <strong>Target: Checkpoint #${currentCount + 1}</strong><br>
               ${target ? hintText(target) : "Loading..."}
            </div>
          </div>
        </div>
      `));
    }

    function renderLogin() {
      app.innerHTML = "";
      const node = el(`
        <div>
          ${headerHtml(t("LOGIN_TITLE"), "", true)}
          <div class="card">
            <div class="card-title">${t("LOGIN_CARD_TITLE")}</div>
            <p class="card-subtitle">${t("LOGIN_DESC")}</p>

            <div class="input-group">
              <label class="input-label" for="nick">${t("LABEL_NAME")}</label>
              <input id="nick" name="nickname" maxlength="20" placeholder="${t("PH_NAME")}" aria-required="true" aria-label="${t("LABEL_NAME")}" />
            </div>

            <div class="input-group">
              <label class="input-label" for="pin">${t("LABEL_PIN")}</label>
              <input id="pin" name="pin" type="password" inputmode="numeric" maxlength="4" placeholder="${t("PH_PIN")}" aria-required="true" aria-label="${t("LABEL_PIN")}" />
            </div>

            <button id="btn" type="button" aria-label="${t("BTN_LOGIN")}">${t("BTN_LOGIN")}</button>
            <div id="msg"></div>

            <div class="divider"></div>
            <p class="text-center text-muted">
              ${t("LOGIN_TO_SIGNUP")} <a class="link" href="#/signup">${t("LINK_SIGNUP")}</a>
            </p>
          </div>
        </div>
      `);

      node.querySelector("#btn").onclick = async () => {
        const btn = node.querySelector("#btn");
        const nick = node.querySelector("#nick").value.trim();
        const pin = node.querySelector("#pin").value.trim();
        const msg = node.querySelector("#msg");
        msg.innerHTML = "";

        if (!nick) { msg.innerHTML = `<div class="alert alert-error">${t("NEED_NAME")}</div>`; node.classList.add("shake"); setTimeout(() => node.classList.remove("shake"), 300); return; }
        if (!/^[0-9]{4}$/.test(pin)) { msg.innerHTML = `<div class="alert alert-error">${t("NEED_PIN_4")}</div>`; node.classList.add("shake"); setTimeout(() => node.classList.remove("shake"), 300); return; }

        btn.disabled = true; btn.textContent = t("BTN_CHECKING");

        try {
          await retryOperation(async () => {
            await ensureAnonLogin();
            const { error } = await sb.rpc("claim_player", { nick, pin });
            if (error) throw error;
          }, 3, 1000);

          msg.innerHTML = `<div class="alert alert-success">${t("LOGIN_OK")}</div>`;
          showToast(t("LOGIN_OK"), "success", 2000);
          setTimeout(() => location.hash = "#/", 350);
        } catch (e) {
          const errorMsg = t("LOGIN_FAIL", { msg: (e?.message ?? e) });
          msg.innerHTML = `<div class="alert alert-error">${errorMsg}</div>`;
          showToast(errorMsg, "error", 4000);
          node.classList.add("shake"); setTimeout(() => node.classList.remove("shake"), 300);
        } finally {
          btn.disabled = false; btn.textContent = t("BTN_LOGIN");
        }
      };

      app.appendChild(node);
    }

    function renderSignup() {
      app.innerHTML = "";
      const node = el(`
        <div>
          ${headerHtml(t("SIGNUP_TITLE"), "", true)}
          <div class="card">
            <div class="card-title">${t("SIGNUP_CARD_TITLE")}</div>
            <p class="card-subtitle">${t("SIGNUP_DESC")}</p>

            <div class="input-group">
              <label class="input-label" for="nick">${t("LABEL_NAME")}</label>
              <input id="nick" name="nickname" maxlength="20" placeholder="${t("PH_NAME")}" aria-required="true" aria-label="${t("LABEL_NAME")}" />
            </div>

            <div class="input-group">
              <label class="input-label" for="room">${t("LABEL_ROOM")}</label>
              <input id="room" name="room" maxlength="10" placeholder="${t("PH_ROOM")}" aria-required="true" aria-label="${t("LABEL_ROOM")}" />
            </div>

            <div class="input-group">
              <label class="input-label" for="pin">${t("LABEL_PIN")}</label>
              <input id="pin" name="pin" type="password" inputmode="numeric" maxlength="4" placeholder="${t("PH_PIN")}" aria-required="true" aria-label="${t("LABEL_PIN")}" />
            </div>

            <button id="btn" type="button" aria-label="${t("BTN_SIGNUP")}">${t("BTN_SIGNUP")}</button>
            <div id="msg"></div>

            <div class="divider"></div>
            <p class="text-center text-muted">
              ${t("SIGNUP_TO_LOGIN")} <a class="link" href="#/login">${t("LINK_LOGIN")}</a>
            </p>
          </div>
        </div>
      `);

      node.querySelector("#btn").onclick = async () => {
        const btn = node.querySelector("#btn");
        const nick = node.querySelector("#nick").value.trim();
        const room = node.querySelector("#room").value.trim();
        const pin = node.querySelector("#pin").value.trim();
        const msg = node.querySelector("#msg");
        msg.innerHTML = "";

        if (!nick) { msg.innerHTML = `<div class="alert alert-error">${t("NEED_NAME")}</div>`; node.classList.add("shake"); setTimeout(() => node.classList.remove("shake"), 300); return; }
        if (!room) { msg.innerHTML = `<div class="alert alert-error">${t("NEED_ROOM")}</div>`; node.classList.add("shake"); setTimeout(() => node.classList.remove("shake"), 300); return; }
        if (!/^[0-9]{4}$/.test(pin)) { msg.innerHTML = `<div class="alert alert-error">${t("NEED_PIN_4")}</div>`; node.classList.add("shake"); setTimeout(() => node.classList.remove("shake"), 300); return; }

        btn.disabled = true; btn.textContent = t("BTN_CHECKING");

        try {
          await retryOperation(async () => {
            // âœ… Ensure anonymous session exists before calling RPC
            const session = await ensureAnonLogin();
            if (!session) throw new Error("Failed to establish session");

            const { error } = await sb.rpc("register_player", { nick, pin, room });
            if (error) {
              if (error.message.includes("already registered")) {
                // If already registered, we should try to claim this profile or just redirect
                // But typically this means they should login instead.
                throw new Error("Already registered. Please login.");
              }
              throw error;
            }
          }, 3, 1000);

          msg.innerHTML = `<div class="alert alert-success">${t("SIGNUP_OK")}</div>`;
          showToast(t("SIGNUP_OK"), "success", 2000);
          setTimeout(() => location.hash = "#/", 350);
        } catch (e) {
          const errorMsg = t("SIGNUP_FAIL", { msg: (e?.message ?? e) });
          msg.innerHTML = `<div class="alert alert-error">${errorMsg}</div>`;
          showToast(errorMsg, "error", 4000);
          node.classList.add("shake"); setTimeout(() => node.classList.remove("shake"), 300);
        } finally {
          btn.disabled = false; btn.textContent = t("BTN_SIGNUP");
        }
      };

      app.appendChild(node);
    }

    function renderCheckpoint(nickname, prog, cpRoute) {
      app.innerHTML = "";

      const target = cpRoute.find(cp => !prog.cleared_checkpoints.includes(cp));
      const isClearedAll = !target;
      const currentStep = prog.cleared_checkpoints.length + 1;

      const node = el(`
        <div>
          ${headerHtml(t("CP_TITLE"), `<div class="badge">ğŸ“ ${prog.cleared_checkpoints.length}/${MAX_CHECKPOINT}</div>`, true)}
          <div class="checkpoint-card">
            <div class="checkpoint-number">#${currentStep}</div>
            <div style="font-weight:900;letter-spacing:.08em;">Find Checkpoint ${target}</div>
          </div>

          <div class="card">
            ${isClearedAll ? `
                <div class="alert alert-success">${t("CLEAR_DESC")}</div>
                <button type="button" onclick="location.hash='#/clear'">${t("BTN_VIEW_ME")}</button>
              ` : `
                <div class="card-title">${t("CP_VERIFY_TITLE")}</div>
                <p class="card-subtitle">${t("CP_VERIFY_DESC")}</p>

                <div class="input-group">
                  <label class="input-label" for="pass">${t("LABEL_PASS")}</label>
                  <input id="pass" name="passphrase" maxlength="30" placeholder="${t("PH_PASS")}" aria-required="true" aria-label="${t("LABEL_PASS")}" />
                </div>

                <button id="claim" type="button" aria-label="${t("BTN_CLAIM")}">${t("BTN_CLAIM")}</button>
                <div id="msg"></div>

                <div class="hint-box">
                  <strong>${t("HINT_TITLE", { n: currentStep })}</strong><br>
                  ${target ? hintText(target) : ""}
                </div>
              `
        }
          </div>
        </div>
      `);

      if (!isClearedAll) {
        node.querySelector("#claim").onclick = async () => {
          const btn = node.querySelector("#claim");
          const msg = node.querySelector("#msg");
          const pass = node.querySelector("#pass").value.trim().toUpperCase();

          msg.innerHTML = "";
          btn.disabled = true; btn.textContent = t("BTN_CHECKING");

          try {
            const me = await retryOperation(async () => await getMe(), 3, 1000);
            const res = await retryOperation(async () => await advanceWithPassphrase(me.id, target, pass), 3, 1000);

            if (!res.ok) {
              let errorMsg = "";
              if (res.reason === "no_passphrase") errorMsg = t("PASS_REQUIRED");
              else if (res.reason === "invalid_passphrase") errorMsg = t("PASS_WRONG");
              else if (res.reason === "wrong_order") errorMsg = t("ORDER_WRONG", { cur: res.current, max: MAX_CHECKPOINT });
              else errorMsg = t("FAIL_GENERIC", { msg: (res.message ?? "error") });

              msg.innerHTML = `<div class="alert alert-error">${errorMsg}</div>`;
              showToast(errorMsg, "error", 3000);
              btn.disabled = false; btn.textContent = t("BTN_CLAIM");
              return;
            }

            showToast(t("UNLOCKED"), "success", 3000);
            setTimeout(() => handleRoute(), 450); // Refresh to show next step or clear
          } catch (e) {
            const errorMsg = t("FAIL_GENERIC", { msg: (e?.message ?? e) });
            msg.innerHTML = `<div class="alert alert-error">${errorMsg}</div>`;
            showToast(errorMsg, "error", 4000);
            btn.disabled = false; btn.textContent = t("BTN_CLAIM");
          }
        };
      }

      app.appendChild(node);
    }

    function renderTrap(nickname, prog, reason) {
      app.innerHTML = "";
      const lines = [t("TRAP_LINE_1"), t("TRAP_LINE_2"), t("TRAP_LINE_3"), t("TRAP_LINE_4")];
      const msg = lines[Math.floor(Math.random() * lines.length)];

      app.appendChild(el(`
        <div>
          ${headerHtml(t("TRAP_TITLE"), "", true)}
          <div class="card trapCard">
            <div style="display:flex;align-items:center;gap:12px;">
              <div class="trapSkull">ğŸ’€</div>
              <div>
                <div class="glitch" data-text="TRAP">TRAP</div>
                <div class="text-muted" style="margin-top:6px;">${msg}</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="smallHint">
              <div>${t("TRAP_NOTE_1")}</div>
              <div>${t("TRAP_NOTE_2")}</div>
              ${reason ? `<div style="opacity:.7;margin-top:6px;">debug: ${reason}</div>` : ``}
            </div>

            <div style="margin-top:14px;">
              <button type="button" onclick="location.hash='#/'">${t("BTN_BACK_HOME")}</button>
            </div>
          </div>
        </div>
      `));
    }

    function renderClear(nickname) {
      app.innerHTML = "";
      app.appendChild(el(`
        <div>
          ${headerHtml(t("CLEAR_TITLE"), "", true)}
          <div class="card">
            <div class="card-title">${t("CLEAR_CONGRATS", { name: nickname })}</div>
            <p class="card-subtitle">${t("CLEAR_DESC")}</p>

            <div class="hint-box">
              <strong>${t("CLEAR_PRIZE_TITLE")}</strong><br>${t("CLEAR_PRIZE_DESC")}
            </div>

            <div class="divider"></div>

            <button type="button" onclick="location.hash='#/me'">${t("BTN_VIEW_ME")}</button>
            <button class="btn-secondary" type="button" onclick="location.hash='#/'">${t("BTN_HOME")}</button>
          </div>
        </div>
      `));
    }

    function renderScan(nickname, prog) {
      app.innerHTML = "";
      const ios = isIOS();

      app.appendChild(el(`
        <div>
          ${headerHtml(t("SCAN_TITLE"), `<div class="badge">ğŸ“ ${prog.cleared_checkpoints?.length || 0}/${MAX_CHECKPOINT}</div>`, true)}
          <div class="card">
            <div class="card-title">${t("SCAN_CARD_TITLE")}</div>
            ${ios ? `
                <div class="alert alert-success">${t("SCAN_IOS_TIP")}</div>
                <p class="card-subtitle">${t("SCAN_IOS_DESC")}</p>
              ` : `
                <div class="alert alert-success">${t("SCAN_ANDROID_DESC")}</div>
              `
        }
          </div>
        </div>
      `));
    }

    function renderMe(nickname, prog) {
      app.innerHTML = "";

      const count = prog.cleared_checkpoints?.length ?? 0;
      let hintsHtml = "";
      const cleared = prog.cleared_checkpoints || [];
      if (cleared.length > 0) {
        hintsHtml = cleared.map((cp, idx) => `
          <div class="list-item">
            <div>
              <strong>Step ${idx + 1} (CP ${cp})</strong>
              <div class="text-muted" style="font-size:13px;margin-top:4px;line-height:1.5;">${hintText(cp)}</div>
            </div>
            <div style="font-size:18px;">âœ…</div>
          </div>
        `).join("");
      } else {
        hintsHtml = `<p class="text-muted">${t("ME_NO_HINTS")}</p>`;
      }

      app.appendChild(el(`
        <div>
          ${headerHtml(t("ME_TITLE"), "", true)}
          <div class="card">
            <div class="card-title">${nickname}</div>

            <div class="stats">
              <div class="stat-item">
                <div class="stat-value">${count}</div>
                <div class="stat-label">${t("ME_PROGRESS")}</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${progressPercent(count)}%</div>
                <div class="stat-label">${t("ME_RATE")}</div>
              </div>
            </div>

            <div class="progress-container">
              <div class="progress-bar" style="width:${progressPercent(count)}%"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-title">${t("ME_HINTS_TITLE")}</div>
            <div style="margin-top:14px;">${hintsHtml}</div>
          </div>
        </div>
      `));
    }

    async function renderLeaderboard(nickname) {
      app.innerHTML = "";
      app.appendChild(el(`
        <div>
          ${headerHtml(t("RANK_TITLE"), "", true)}
          <div class="card">
            <div class="card-title">${t("RANK_CARD_TITLE")}</div>
            <p class="card-subtitle">${t("RANK_DESC")}</p>
            <div id="list">
              <div style="display:flex;align-items:center;justify-content:center;padding:40px;">
                <div class="spinner spinner-large"></div>
              </div>
            </div>
          </div>
        </div>
      `));

      const list = document.getElementById("list");

      try {
        const data = await retryOperation(async () => {
          const { data, error } = await sb.rpc("get_leaderboard");
          if (error) throw error;
          return data;
        }, 3, 1000);

        if (!data?.length) {
          list.innerHTML = `<p class="text-muted text-center">${t("EMPTY")}</p>`;
          return;
        }

        list.innerHTML = data.map((r, idx) => {
          const isMe = (r.nickname === nickname);
          const topClass = idx === 0 ? "rank-1" : idx === 1 ? "rank-2" : idx === 2 ? "rank-3" : "";
          const isClear = (r.checkpoint >= MAX_CHECKPOINT);
          const progressText = `${r.checkpoint} / ${MAX_CHECKPOINT}`;

          return `
            <div class="list-item ${isMe ? "active" : ""} ${topClass}">
              <div style="display:flex;align-items:center;gap:12px;flex:1;">
                <div class="rank-number">#${idx + 1}</div>
                <div style="display:flex;align-items:center;flex-wrap:wrap;">
                  <strong>${r.nickname}</strong>
                  ${isMe ? `<span class="me-badge">${t("YOU_BADGE")}</span>` : ``}
                </div>
              </div>
              <div class="finish">
                <span>${progressText}</span>
                ${isClear ? `<span class="done">ğŸ‰</span>` : ``}
              </div>
            </div>
          `;
        }).join("");

      } catch (e) {
        const errorMsg = t("FAIL_GENERIC", { msg: (e?.message ?? e) });
        list.innerHTML = `<div class="alert alert-error">${errorMsg}</div>`;
        showToast(errorMsg, "error", 4000);
      }
    }

    // ====== main route ======
    async function handleRoute() {
      const r = getRoute();
      setNavActive();

      if (r.type === "intro") { return renderIntro(); }
      if (r.type === "login") { return renderLogin(); }
      if (r.type === "signup") { return renderSignup(); }

      showLoading(t("LOADING"));
      try {
        const me = await ensureAnonLogin();
        let nick = null;
        let prog = { checkpoint: 0, updated_at: null, cleared_checkpoints: [] };

        try {
          nick = await getNickname(me.id);
          if (nick) {
            prog = await getProgress(me.id);
          }
        } catch (e) { }

        if (!nick) {
          hideLoading();
          return (location.hash = "#/login");
        }

        const myRoute = getUserRoute(me.id, supportsRandomRoutes !== false);
        const currentTarget = myRoute.find(cp => !(prog.cleared_checkpoints || []).includes(cp));

        if (r.type === "home") {
          hideLoading();
          if (!currentTarget) return (location.hash = "#/clear");
          return renderHome(nick, prog, myRoute);
        }

        if (r.type === "leaderboard") {
          hideLoading();
          return renderLeaderboard(nick);
        }

        if (r.type === "me") {
          hideLoading();
          return renderMe(nick, prog);
        }

        if (r.type === "scan") {
          hideLoading();
          return renderScan(nick, prog);
        }

        if (r.type === "clear") {
          hideLoading();
          if (currentTarget) return (location.hash = "#/");
          return renderClear(nick);
        }

        if (r.type === "cp") {
          hideLoading();
          if (!myRoute.includes(r.n)) {
            showToast("Invalid CP", "error");
            location.hash = "#/";
            return;
          }
          if ((prog.cleared_checkpoints || []).includes(r.n)) {
            showToast("Already cleared!", "success");
            location.hash = "#/";
            return;
          }
          if (r.n !== currentTarget) {
            showToast(`Not your target!`, "error", 4000);
            app.innerHTML = "";
            app.appendChild(el(`<div>${headerHtml(t("TRAP_TITLE"), "", true)}<div class="card"><div class="alert alert-error">Wrong Location</div><button class="btn-secondary" onclick="location.hash='#/'">Back Home</button></div></div>`));
            return;
          }
          if (!CP_KEYS[r.n] || r.key !== CP_KEYS[r.n]) {
            renderTrap(nick, prog, "KEY_MISMATCH");
            return;
          }
          return renderCheckpoint(nick, prog, myRoute);
        }

        location.hash = "#/";

      } catch (e) {
        hideLoading();
        console.error(e);
        app.innerHTML = `<div class="card"><div class="alert alert-error">${t("ERR_TITLE")}<br>${e.message}</div></div>`;
      }
    }

    window.addEventListener("hashchange", handleRoute);
    if (!location.hash) location.hash = "#/intro";
    window.addEventListener("load", () => {
      applyStaticI18n();
      handleRoute();
    });

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js")
          .then(reg => console.log("Service Worker registered:", reg))
          .catch(err => console.log("Service Worker registration failed:", err));
      });
    }

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") hideLoading();
    });

    window.addEventListener("online", () => {
      showToast("Back online", "success", 2500);
    });
    window.addEventListener("offline", () => {
      showToast("Offline", "error", 3500);
    });
  </script>
</body>

</html>
